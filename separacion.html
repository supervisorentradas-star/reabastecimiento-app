<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Separaci√≥n - REABASTECIMIENTO SOKSO</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: white;
            padding: 10px;
            color: black;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        h1 {
            color: #6600a1;
            font-size: 22px;
            margin-bottom: 8px;
        }
        .connection-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .connection-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .connected {
            background-color: #27ae60;
        }
        .disconnected {
            background-color: #e74c3c;
        }
        .checking {
            background-color: #f39c12;
        }
        .data-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .load-section {
            text-align: center;
            margin-bottom: 10px;
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            background: #6600a1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .scan-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            text-align: center;
            border: 1px dashed #bdc3c7;
        }
        .upc-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #6600a1;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 10px;
            background: white;
        }
        .refresh-btn {
            background: #6600a1;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .result-section {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #6600a1;
            flex: 1;
            overflow-y: auto;
        }
        .result-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 8px;
            color: #6600a1;
            font-size: 16px;
        }
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin: 8px 0;
        }
        .result-cell {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
        }
        .result-label {
            font-size: 9px;
            color: #7f8c8d;
            margin-bottom: 2px;
        }
        .result-value {
            font-size: 11px;
            color: #6600a1;
        }
        .deposito-display {
            background: #6600a1;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        .articulo-info {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            text-align: center;
            color: #7f8c8d;
            font-size: 11px;
            border: 1px solid #ddd;
        }
        .status-section {
            margin: 8px 0;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .cache-info {
            font-size: 9px;
            color: #7f8c8d;
            text-align: center;
            margin-top: 6px;
        }
        .footer {
            margin-top: 8px;
        }
        .back-button {
            background: #6600a1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- CABECERA MEJORADA -->
        <div class="header">
            <h1>SEPARACI√ìN SOKSO</h1>
            <div class="connection-status">
                <div class="connection-item">
                    <div id="firebaseIndicator" class="connection-indicator checking"></div>
                    <span>FIRE</span>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE DATOS -->
        <div class="data-section">
            <!-- ESTADO DE DATOS -->
            <div class="status-section status-info" id="dataStatus">
                üìä Presiona "Cargar Datos" para comenzar
            </div>

            <!-- SECCI√ìN DE CARGA -->
            <div class="load-section">
                <button class="btn-small" onclick="cargarDatosDesdeFirebase()">üì• Cargar Sloting</button>
            </div>

            <!-- SECCI√ìN DE ESCANEO -->
            <div class="scan-section">
                <h3>ESCANEAR C√ìDIGO UPC</h3>
                <input type="text" 
                       id="upcInput" 
                       class="upc-input" 
                       placeholder="Escanear c√≥digo UPC" 
                       autocomplete="off">
                
                <button class="refresh-btn" onclick="limpiarConsulta()">‚Üª</button>
            </div>

            <!-- SECCI√ìN DE RESULTADOS -->
            <div class="result-section hidden" id="resultSection">
                <div class="result-header">REPORTE DE REABASTECIMIENTO</div>
                
                <div class="result-grid">
                    <div class="result-cell">
                        <div class="result-label">RUTA</div>
                        <div class="result-value" id="resultRuta">-</div>
                    </div>
                    <div class="result-cell">
                        <div class="result-label">BLOQUE</div>
                        <div class="result-value" id="resultBloque">-</div>
                    </div>
                    <div class="result-cell">
                        <div class="result-label">NIVEL</div>
                        <div class="result-value" id="resultNivel">-</div>
                    </div>
                </div>

                <div class="deposito-display" id="resultDeposito">-</div>

                <div class="articulo-info">
                    <strong>Art√≠culo:</strong> <span id="resultArticulo">-</span>
                </div>
            </div>

            <!-- INFORMACI√ìN DE CACHE -->
            <div class="cache-info" id="cacheInfo">
                √öltima actualizaci√≥n: No disponible
            </div>
        </div>

        <!-- BOT√ìN VOLVER AL PRINCIPAL -->
        <div class="footer">
            <button class="back-button" onclick="volverAlPrincipal()">
                ‚Ü©Ô∏è Volver al Sistema Principal
            </button>
        </div>
    </div>

    <script>
        // ================= CONFIGURACI√ìN FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyAl6wzWg_opgBrZ4fe0golJ-fe-civk7RE",
            authDomain: "reabastecimiento-d71a1.firebaseapp.com",
            databaseURL: "https://reabastecimiento-d71a1-default-rtdb.firebaseio.com",
            projectId: "reabastecimiento-d71a1",
            storageBucket: "reabastecimiento-d71a1.firebasestorage.app",
            messagingSenderId: "107012533068",
            appId: "1:107012533068:web:3576d5e3a18a42dcaefde9"
        };

        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas

        // ================= VARIABLES GLOBALES =================
        let datosSloting = {};
        let ultimaActualizacion = null;

        // ================= INICIALIZAR FIREBASE =================
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ================= INICIALIZACI√ìN =================
        window.addEventListener('load', function() {
            inicializarFirebase();
            cargarDatosDesdeCache();
            
            // B√∫squeda autom√°tica al escribir
            document.getElementById('upcInput').addEventListener('input', function(e) {
                const upc = e.target.value.trim();
                if (upc.length >= 8) {
                    consultarDestino(upc);
                }
            });

            document.getElementById('upcInput').focus();
        });

        // ================= CONEXI√ìN FIREBASE =================
        function inicializarFirebase() {
            try {
                verificarConexionFirebase();
            } catch (error) {
                document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
            }
        }

        function verificarConexionFirebase() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator connected';
                } else {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
                }
            });
        }

        // ================= CARGA DE DATOS DESDE FIREBASE =================
        async function cargarDatosDesdeFirebase() {
            try {
                mostrarEstado('üì• Cargando desde Firebase...', 'info');
                
                const snapshot = await database.ref('sloting').once('value');
                const datosFirebase = snapshot.val();
                
                if (!datosFirebase || Object.keys(datosFirebase).length === 0) {
                    throw new Error('No hay datos de sloting en Firebase. Contacta al administrador.');
                }
                
                datosSloting = datosFirebase;
                ultimaActualizacion = new Date();
                
                // Guardar en cache local
                guardarEnCache(datosSloting);
                mostrarEstado(`‚úÖ Sloting cargado: ${Object.keys(datosSloting).length} registros`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                mostrarEstado(`‚ùå Error: ${error.message}`, 'error');
                
                // Intentar cargar desde cache como √∫ltimo recurso
                if (!cargarDatosDesdeCache()) {
                    mostrarEstado('‚ö†Ô∏è No hay datos disponibles', 'error');
                }
            }
        }

        // ================= SISTEMA DE CACHE LOCAL =================
        function cargarDatosDesdeCache() {
            try {
                const cacheData = localStorage.getItem('cacheSloting');
                const cacheTime = localStorage.getItem('cacheSlotingTime');
                
                if (cacheData && cacheTime) {
                    const ahora = new Date().getTime();
                    const tiempoTranscurrido = ahora - parseInt(cacheTime);
                    
                    if (tiempoTranscurrido < CACHE_DURATION) {
                        datosSloting = JSON.parse(cacheData);
                        ultimaActualizacion = new Date(parseInt(cacheTime));
                        actualizarInfoCache();
                        mostrarEstado('‚úÖ Datos cargados desde cache', 'success');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error cargando cache:', error);
                return false;
            }
        }

        function guardarEnCache(datos) {
            try {
                localStorage.setItem('cacheSloting', JSON.stringify(datos));
                localStorage.setItem('cacheSlotingTime', new Date().getTime().toString());
                actualizarInfoCache();
            } catch (error) {
                console.error('Error guardando cache:', error);
            }
        }

        function actualizarInfoCache() {
            const infoDiv = document.getElementById('cacheInfo');
            if (ultimaActualizacion) {
                const ahora = new Date();
                const diffMs = ahora - ultimaActualizacion;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                let textoTiempo;
                if (diffHours > 0) {
                    textoTiempo = `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                } else if (diffMins > 0) {
                    textoTiempo = `Hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
                } else {
                    textoTiempo = 'Reci√©n actualizado';
                }
                
                infoDiv.textContent = `Sloting: ${Object.keys(datosSloting).length} registros | ${textoTiempo}`;
            }
        }

        // ================= CONSULTA DE DESTINO =================
        function consultarDestino(upc) {
            // Limpiar espacios y caracteres especiales
            upc = upc.trim().replace(/\s/g, '');
            
            const resultado = datosSloting[upc];
            const resultSection = document.getElementById('resultSection');
            
            if (!resultado) {
                mostrarEstado('‚ùå UPC no encontrado en el sloting', 'error');
                resultSection.classList.add('hidden');
                return;
            }
            
            const info = extraerInformacionDeposito(resultado.deposito);
            
            document.getElementById('resultRuta').textContent = info.ruta;
            document.getElementById('resultBloque').textContent = info.bloque;
            document.getElementById('resultNivel').textContent = info.nivel;
            document.getElementById('resultDeposito').textContent = resultado.deposito;
            document.getElementById('resultArticulo').textContent = resultado.articulo;
            
            resultSection.classList.remove('hidden');
            mostrarEstado('‚úÖ Destino encontrado', 'success');
            
            // Auto-limpiar despu√©s de mostrar resultados
            setTimeout(() => {
                document.getElementById('upcInput').value = '';
            }, 800);
        }

        function extraerInformacionDeposito(deposito) {
            let ruta = '';
            let bloque = '';
            let nivel = '';
            
            // Extraer ruta
            const matchRuta = deposito.match(/(?:P)?(\d+)/);
            if (matchRuta) {
                ruta = matchRuta[1].replace(/^0+/, ''); // Remover ceros a la izquierda
            }
            
            // Extraer n√∫mero de dep√≥sito
            const matchNumero = deposito.match(/-(\d+)-/);
            let numeroDeposito = 0;
            if (matchNumero) {
                numeroDeposito = parseInt(matchNumero[1]);
            } else {
                // Alternativa para formato 8-009-3-A
                const matchAlt = deposito.match(/-(\d+)/);
                if (matchAlt) {
                    numeroDeposito = parseInt(matchAlt[1]);
                }
            }
            
            // Extraer nivel (√∫ltima letra)
            const matchNivel = deposito.match(/([A-Z])$/);
            if (matchNivel) {
                nivel = matchNivel[1];
            }
            
            // Determinar bloque seg√∫n reglas
            const rutaNum = parseInt(ruta);
            if (rutaNum >= 1 && rutaNum <= 8) {
                bloque = (numeroDeposito <= 66) ? 'A' : 'D';
            } else {
                bloque = 'Toldo';
            }
            
            return { ruta, bloque, nivel, numeroDeposito };
        }

        // ================= UTILIDADES =================
        function mostrarEstado(mensaje, tipo) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = mensaje;
            statusDiv.className = 'status-section';
            
            switch(tipo) {
                case 'success': statusDiv.classList.add('status-success'); break;
                case 'error': statusDiv.classList.add('status-error'); break;
                case 'info': statusDiv.classList.add('status-info'); break;
            }
        }

        function limpiarConsulta() {
            document.getElementById('upcInput').value = '';
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('upcInput').focus();
            mostrarEstado('Consulta limpiada - Listo para escanear', 'info');
        }

        function volverAlPrincipal() {
            window.location.href = 'index.html';
        }

        // Sincronizaci√≥n autom√°tica cada hora
        setInterval(() => {
            if (Object.keys(datosSloting).length > 0) {
                cargarDatosDesdeFirebase();
            }
        }, 60 * 60 * 1000);

        // Cargar datos autom√°ticamente al iniciar si hay cache
        setTimeout(() => {
            if (Object.keys(datosSloting).length === 0) {
                cargarDatosDesdeCache();
            }
        }, 500);
    </script>
</body>
</html>