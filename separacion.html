<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Separaci√≥n</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #f0f2f5;
            padding: 10px;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        h1 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 10px;
        }
        .load-section {
            text-align: center;
            margin-bottom: 15px;
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .scan-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px dashed #bdc3c7;
        }
        .upc-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #3498db;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
            background: white;
        }
        .result-section {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #3498db;
        }
        .result-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        .result-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }
        .result-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.1em;
            font-weight: bold;
        }
        .articulo-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            font-style: italic;
            color: #7f8c8d;
        }
        .status-section {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .hidden {
            display: none;
        }
        .cache-info {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABECERA -->
        <div class="header">
            <h1>M√ìDULO DE SEPARACI√ìN</h1>
            <div class="load-section">
                <button class="btn-small" onclick="cargarDatos()">üì• Cargar Datos</button>
            </div>
        </div>

        <!-- ESTADO DE DATOS -->
        <div class="status-section status-info" id="dataStatus">
            üìä Presiona "Cargar Datos" para comenzar
        </div>

        <!-- SECCI√ìN DE ESCANEO -->
        <div class="scan-section">
            <h3>ESCANEAR C√ìDIGO UPC</h3>
            <input type="text" 
                   id="upcInput" 
                   class="upc-input" 
                   placeholder="Escanear c√≥digo UPC" 
                   autocomplete="off">
            
            <div class="controls">
                <button class="btn-warning" onclick="limpiarConsulta()">üîÑ Limpiar</button>
            </div>
        </div>

        <!-- SECCI√ìN DE RESULTADOS -->
        <div class="result-section hidden" id="resultSection">
            <div class="result-header">REPORTE DE REABASTECIMIENTO</div>
            
            <table class="result-table">
                <thead>
                    <tr>
                        <th>RUTA</th>
                        <th>BLOQUE</th>
                        <th>DEPOSITO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="resultRuta">-</td>
                        <td id="resultBloque">-</td>
                        <td id="resultDeposito">-</td>
                    </tr>
                </tbody>
            </table>

            <div class="articulo-info">
                <strong>Art√≠culo:</strong> <span id="resultArticulo">-</span>
            </div>
        </div>

        <!-- INFORMACI√ìN DE CACHE -->
        <div class="cache-info" id="cacheInfo">
            √öltima actualizaci√≥n: No disponible
        </div>

        <!-- BOT√ìN VOLVER AL PRINCIPAL -->
        <button class="btn-primary" onclick="volverAlPrincipal()" style="width: 100%; margin-top: 15px;">
            ‚Ü©Ô∏è Volver al Sistema Principal
        </button>
    </div>

    <script>
        // ================= CONFIGURACI√ìN CORREGIDA =================
        const SHEET_ID = '1speGU8wY9QVuN3Piis75d6V0bxtlh9FDp25yNpOizPI';
        // Usamos la URL de exportaci√≥n CSV p√∫blica
        const GOOGLE_SHEETS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=0`;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

        // ================= VARIABLES GLOBALES =================
        let datosDestino = {};
        let ultimaActualizacion = null;

        // ================= INICIALIZACI√ìN =================
        window.addEventListener('load', function() {
            cargarDatosDesdeCache();
            
            // B√∫squeda autom√°tica al escribir
            document.getElementById('upcInput').addEventListener('input', function(e) {
                const upc = e.target.value.trim();
                if (upc.length >= 8) {
                    consultarDestino(upc);
                }
            });

            document.getElementById('upcInput').focus();
        });

        // ================= CARGA DE DATOS MEJORADA =================
        async function cargarDatos() {
            try {
                mostrarEstado('üì• Conectando con Google Sheets...', 'info');
                
                // Intentar m√∫ltiples formatos de URL
                let csvText = '';
                let error = null;
                
                // Intentar con la URL est√°ndar
                try {
                    csvText = await cargarDesdeGoogleSheets(GOOGLE_SHEETS_URL);
                } catch (err1) {
                    error = err1;
                    // Intentar con URL alternativa
                    const altUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
                    try {
                        csvText = await cargarDesdeGoogleSheets(altUrl);
                    } catch (err2) {
                        // Intentar con la URL p√∫blica que proporcionaste
                        const publicUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZEEl_DIwDbLQIZ9FcsmxSTWLXPiP5XoLRBCd8BuPkefwW-nCzFq7HGDTnNg4Ob7VSwFIgCaajxE6X/pub?output=csv';
                        csvText = await cargarDesdeGoogleSheets(publicUrl);
                    }
                }
                
                procesarCSV(csvText);
                guardarEnCache(csvText);
                mostrarEstado('‚úÖ Datos cargados correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                mostrarEstado(`‚ùå Error: ${error.message}`, 'error');
                
                // Intentar cargar desde cache como √∫ltimo recurso
                if (!cargarDatosDesdeCache()) {
                    mostrarEstado('‚ö†Ô∏è Usando datos de demostraci√≥n', 'info');
                    cargarDatosDemo();
                }
            }
        }

        async function cargarDesdeGoogleSheets(url) {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: No se pudo conectar`);
            }
            
            const csvText = await response.text();
            
            if (!csvText || csvText.includes('error') || csvText.length < 10) {
                throw new Error('No hay datos disponibles');
            }
            
            return csvText;
        }

        function procesarCSV(csvText) {
            datosDestino = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                throw new Error('El archivo CSV est√° vac√≠o');
            }
            
            // Detectar separador
            const primeraLinea = lineas[0];
            const separador = primeraLinea.includes('\t') ? '\t' : ',';
            
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => 
                    part.trim().replace(/^"|"$/g, '')
                );
                
                if (partes.length >= 3) {
                    const upc = partes[0];
                    const articulo = partes[1];
                    const deposito = partes[2];
                    
                    if (upc && deposito) {
                        datosDestino[upc] = {
                            articulo: articulo,
                            deposito: deposito
                        };
                    }
                }
            }
            
            ultimaActualizacion = new Date();
            actualizarInfoCache();
            
            console.log(`üìä Datos procesados: ${Object.keys(datosDestino).length} registros`);
        }

        // ================= DATOS DE DEMOSTRACI√ìN (backup) =================
        function cargarDatosDemo() {
            datosDestino = {
                '2050003333436': {
                    articulo: 'REE-100202217-NEGR-10',
                    deposito: 'P01-005-A'
                },
                '2050003480000': {
                    articulo: 'ESK-ZA_A146-CHOC-38',
                    deposito: 'P05-125-B'
                },
                '2050003021487': {
                    articulo: 'SKS-MNG_065-NEGR-37',
                    deposito: 'P08-050-A'
                },
                '2050003188852': {
                    articulo: 'SKS-ADO_252-HUES-36',
                    deposito: '8-002-2-A'
                },
                '2050003190961': {
                    articulo: 'SKS-ADO_249-BLAN-38',
                    deposito: '8-009-3-A'
                },
                '2050003479578': {
                    articulo: 'ESK-ZA_B154-CAPI-37',
                    deposito: 'P18-052-B'
                }
            };
            
            ultimaActualizacion = new Date();
            actualizarInfoCache();
            mostrarEstado('‚úÖ Datos de demostraci√≥n cargados', 'success');
        }

        // ================= SISTEMA DE CACHE =================
        function cargarDatosDesdeCache() {
            const cacheData = localStorage.getItem('cacheDestinos');
            const cacheTime = localStorage.getItem('cacheDestinosTime');
            
            if (cacheData && cacheTime) {
                const ahora = new Date().getTime();
                const tiempoTranscurrido = ahora - parseInt(cacheTime);
                
                if (tiempoTranscurrido < CACHE_DURATION) {
                    procesarCSV(cacheData);
                    mostrarEstado('‚úÖ Datos cargados desde cache', 'success');
                    return true;
                }
            }
            return false;
        }

        function guardarEnCache(csvText) {
            localStorage.setItem('cacheDestinos', csvText);
            localStorage.setItem('cacheDestinosTime', new Date().getTime().toString());
            actualizarInfoCache();
        }

        function actualizarInfoCache() {
            const infoDiv = document.getElementById('cacheInfo');
            if (ultimaActualizacion) {
                infoDiv.textContent = `√öltima actualizaci√≥n: ${ultimaActualizacion.toLocaleString()}`;
            }
        }

        // ================= CONSULTA AUTOM√ÅTICA =================
        function consultarDestino(upc) {
            const resultado = datosDestino[upc];
            const resultSection = document.getElementById('resultSection');
            
            if (!resultado) {
                mostrarEstado('‚ùå UPC no encontrado', 'error');
                resultSection.classList.add('hidden');
                return;
            }
            
            const info = extraerInformacionDeposito(resultado.deposito);
            
            document.getElementById('resultRuta').textContent = info.ruta;
            document.getElementById('resultBloque').textContent = info.bloque;
            document.getElementById('resultDeposito').textContent = resultado.deposito;
            document.getElementById('resultArticulo').textContent = resultado.articulo;
            
            resultSection.classList.remove('hidden');
            mostrarEstado('‚úÖ Destino encontrado', 'success');
            
            // Auto-limpiar despu√©s de mostrar resultados
            setTimeout(() => {
                document.getElementById('upcInput').value = '';
            }, 1000);
        }

        function extraerInformacionDeposito(deposito) {
            let ruta = '';
            let bloque = '';
            
            // Extraer ruta
            const matchRuta = deposito.match(/(?:P)?(\d+)/);
            if (matchRuta) {
                ruta = matchRuta[1].replace(/^0+/, ''); // Remover ceros a la izquierda
            }
            
            // Extraer n√∫mero de dep√≥sito
            const matchNumero = deposito.match(/-(\d+)-/);
            let numeroDeposito = 0;
            if (matchNumero) {
                numeroDeposito = parseInt(matchNumero[1]);
            } else {
                // Alternativa para formato 8-009-3-A
                const matchAlt = deposito.match(/-(\d+)/);
                if (matchAlt) {
                    numeroDeposito = parseInt(matchAlt[1]);
                }
            }
            
            // Determinar bloque seg√∫n reglas
            const rutaNum = parseInt(ruta);
            if (rutaNum >= 1 && rutaNum <= 8) {
                bloque = (numeroDeposito <= 66) ? 'A' : 'D';
            } else {
                bloque = 'Toldo';
            }
            
            return { ruta, bloque, numeroDeposito };
        }

        // ================= UTILIDADES =================
        function mostrarEstado(mensaje, tipo) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = mensaje;
            statusDiv.className = 'status-section';
            
            switch(tipo) {
                case 'success': statusDiv.classList.add('status-success'); break;
                case 'error': statusDiv.classList.add('status-error'); break;
                case 'info': statusDiv.classList.add('status-info'); break;
            }
        }

        function limpiarConsulta() {
            document.getElementById('upcInput').value = '';
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('upcInput').focus();
            mostrarEstado('Consulta limpiada - Listo para escanear', 'info');
        }

        function volverAlPrincipal() {
            window.location.href = 'index.html';
        }

        // Actualizaci√≥n autom√°tica cada 5 minutos
        setInterval(() => {
            if (Object.keys(datosDestino).length > 0) {
                cargarDatos();
            }
        }, CACHE_DURATION);
    </script>
</body>
</html>