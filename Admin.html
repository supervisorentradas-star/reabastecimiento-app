<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - REABASTECIMIENTO SOKSO</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: white;
            padding: 20px;
            color: black;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        h1 {
            color: #6600a1;
            font-size: 28px;
            margin-bottom: 15px;
        }
        h2 {
            color: #6600a1;
            font-size: 22px;
            margin-bottom: 15px;
        }
        .connection-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }
        .connection-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: bold;
        }
        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .connected {
            background-color: #27ae60;
        }
        .disconnected {
            background-color: #e74c3c;
        }
        .checking {
            background-color: #f39c12;
        }
        .module-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .module-tab {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            /* FIX: Prevenir movimiento al cambiar estado */
            border: 2px solid transparent;
            position: relative;
            top: 0;
        }
        .module-tab.active {
            background: #6600a1;
            color: white;
            /* FIX: Mismo borde pero de color para evitar movimiento */
            border: 2px solid #6600a1;
        }
        .module-tab:hover {
            background: #e0e0e0;
        }
        .module-tab.active:hover {
            background: #55008a;
            border-color: #55008a;
        }
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .admin-button {
            background: #6600a1;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .admin-button:hover {
            background: #55008a;
        }
        .admin-button.warning {
            background: #f39c12;
        }
        .admin-button.warning:hover {
            background: #e67e22;
        }
        .admin-button.success {
            background: #27ae60;
        }
        .admin-button.success:hover {
            background: #219653;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 15px;
        }
        .dashboard-table th, .dashboard-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .dashboard-table th {
            background: #6600a1;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .status-in-progress {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        .status-pending {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        .report-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-item label {
            font-size: 14px;
            font-weight: bold;
        }
        .filter-item input {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .back-button {
            background: #6600a1;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .back-button:hover {
            background: #55008a;
        }
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            display: none;
            font-size: 14px;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #6600a1;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .consistency-check {
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }
        .hidden {
            display: none;
        }
        /* Estilos para el modal de subida de sloting */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal h3 {
            color: #6600a1;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .modal p {
            margin-bottom: 15px;
            color: #333;
            font-size: 14px;
        }
        input[type="password"], input[type="file"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .modal-button.success {
            background: #6600a1;
            color: white;
        }
        .modal-button.warning {
            background: #f0f0f0;
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        .file-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            text-align: left;
        }
        .password-field {
            margin: 15px 0;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin - REABASTECIMIENTO SOKSO</h1>
            <div class="connection-status">
                <div class="connection-item">
                    <div id="firebaseIndicator" class="connection-indicator checking"></div>
                    <span>FIRE</span>
                </div>
                <div class="connection-item">
                    <div id="sheetsIndicator" class="connection-indicator checking"></div>
                    <span>GS</span>
                </div>
            </div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- SELECTOR DE M√ìDULO - MEJORADO SIN PARPADEO -->
        <div class="module-selector">
            <button class="module-tab active" onclick="cambiarModulo('recoleccion', this)">üì¶ Recolecci√≥n</button>
            <button class="module-tab" onclick="cambiarModulo('reposicion', this)">üîÑ Reposici√≥n</button>
            <button class="module-tab" onclick="cambiarModulo('sloting', this)">üì§ Gesti√≥n Sloting</button>
        </div>

        <!-- ESTAD√çSTICAS R√ÅPIDAS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRutas">0</div>
                <div class="stat-label">Rutas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rutasCompletadas">0</div>
                <div class="stat-label">Rutas Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalOperarios">0</div>
                <div class="stat-label">Operarios Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRegistros">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
        </div>

        <!-- CONTROLES ADMIN - PANEL PRINCIPAL -->
        <div id="adminMainPanel" class="admin-controls">
            <button class="admin-button" onclick="actualizarDesdeSheets()">üîÑ Actualizar desde Sheets</button>
            <button class="admin-button warning" onclick="verificarConsistencia()">üîç Verificar Consistencia</button>
            <button class="admin-button" onclick="cargarDashboard()">üìä Actualizar Panel</button>
        </div>

        <!-- CONTROLES ADMIN - PANEL SLOTING -->
        <div id="adminSlotingPanel" class="admin-controls hidden">
            <button class="admin-button success" onclick="solicitarSubirSloting()">üì§ Subir Sloting</button>
            <button class="admin-button warning" onclick="verificarSlotingActual()">üîç Ver Sloting Actual</button>
            <button class="admin-button" onclick="descargarBackupSloting()">üíæ Descargar Backup</button>
        </div>

        <!-- VERIFICACI√ìN DE CONSISTENCIA -->
        <div id="consistencyResults" class="consistency-check hidden">
            <h3>Resultados de Verificaci√≥n</h3>
            <div id="consistencyContent"></div>
        </div>

        <!-- PANEL DE CONTROL - ESTADO DE RUTAS -->
        <div id="routesPanel" class="section">
            <h2 id="panelTitulo">Estado de Rutas - Recolecci√≥n</h2>
            <div id="dashboardLoading" class="loading">Cargando estado de rutas...</div>
            <table class="dashboard-table" id="dashboardTable" style="display:none">
                <thead>
                    <tr>
                        <th>Ruta</th>
                        <th>Cola</th>
                        <th>Estado</th>
                        <th>Recolector</th>
                        <th>Progreso</th>
                        <th>√öltima Actualizaci√≥n</th>
                    </tr>
                </thead>
                <tbody id="dashboardTableBody">
                    <!-- Los datos se llenar√°n din√°micamente -->
                </tbody>
            </table>
        </div>

        <!-- PANEL DE SLOTING -->
        <div id="slotingPanel" class="section hidden">
            <h2>Gesti√≥n de Sloting</h2>
            <div id="slotingInfo" class="file-info">
                <strong>Estado del Sloting:</strong> <span id="slotingStatus">No hay datos cargados</span><br>
                <strong>√öltima actualizaci√≥n:</strong> <span id="slotingLastUpdate">-</span><br>
                <strong>Total de registros:</strong> <span id="slotingTotalRecords">0</span>
            </div>
            
            <div id="slotingPreview" style="margin-top: 15px; display: none;">
                <h3>Vista Previa del Sloting (primeros 5 registros)</h3>
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>CODIGO_UPC</th>
                            <th>ARTICULO</th>
                            <th>DEPOSITO FINAL</th>
                        </tr>
                    </thead>
                    <tbody id="slotingPreviewBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="reportsPanel" class="section">
            <h2>Generar Reportes</h2>
            
            <div class="report-filters">
                <div class="filter-item">
                    <label for="fechaInicioRecoleccion">Fecha Inicio:</label>
                    <input type="date" id="fechaInicioRecoleccion">
                </div>
                <div class="filter-item">
                    <label for="fechaFinRecoleccion">Fecha Fin:</label>
                    <input type="date" id="fechaFinRecoleccion">
                </div>
            </div>
            
            <button class="admin-button" onclick="descargarReporteRecoleccion()" style="width:100%;margin-bottom:15px">
                üìä Descargar Reporte Recolecci√≥n
            </button>

            <div class="report-filters">
                <div class="filter-item">
                    <label for="fechaInicioReposicion">Fecha Inicio:</label>
                    <input type="date" id="fechaInicioReposicion">
                </div>
                <div class="filter-item">
                    <label for="fechaFinReposicion">Fecha Fin:</label>
                    <input type="date" id="fechaFinReposicion">
                </div>
            </div>

            <button class="admin-button" onclick="descargarReporteReposicion()" style="width:100%">
                üìã Descargar Reporte Reposici√≥n
            </button>
        </div>

        <div class="footer">
            <button class="back-button" onclick="volverInterfazPrincipal()">‚Ü©Ô∏è Regresar a Interfaz Principal</button>
        </div>
    </div>

    <!-- MODAL PARA SUBIR SLOTING - CON CONTRASE√ëA -->
    <div id="slotingModal" class="modal">
        <div class="modal-content">
            <h3>Subir Nuevo Sloting</h3>
            <p>Selecciona el archivo CSV con los datos del sloting:</p>
            
            <div class="file-info">
                <strong>Formato esperado:</strong><br>
                - Columnas: CODIGO_UPC, ARTICULO, DEPOSITO FINAL<br>
                - Separador: coma o tabulaci√≥n<br>
                - Codificaci√≥n: UTF-8
            </div>
            
            <!-- CAMPO DE CONTRASE√ëA AGREGADO -->
            <div class="password-field">
                <input type="password" id="slotingPassword" placeholder="Ingresa la contrase√±a (E123456)" required>
            </div>
            
            <input type="file" id="slotingFile" accept=".csv">
            
            <div class="progress-bar" id="uploadProgressBar" style="display: none;">
                <div class="progress-fill" id="uploadProgressFill"></div>
            </div>
            
            <div id="uploadStatus" style="margin: 10px 0; font-size: 14px;"></div>
            
            <div class="modal-buttons">
                <button onclick="procesarSloting()" class="modal-button success">Subir Sloting</button>
                <button onclick="cerrarSlotingModal()" class="modal-button warning">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURACI√ìN FIREBASE Y SHEETS =================
        const firebaseConfig = {
            apiKey: "AIzaSyAl6wzWg_opgBrZ4fe0golJ-fe-civk7RE",
            authDomain: "reabastecimiento-d71a1.firebaseapp.com",
            databaseURL: "https://reabastecimiento-d71a1-default-rtdb.firebaseio.com",
            projectId: "reabastecimiento-d71a1",
            storageBucket: "reabastecimiento-d71a1.firebasestorage.app",
            messagingSenderId: "107012533068",
            appId: "1:107012533068:web:3576d5e3a18a42dcaefde9"
        };

        // URLs p√∫blicas de Google Sheets que funcionan
        const GOOGLE_SHEETS_RECOLECCION_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpi3dSS6SW6p6wnas8gS-976rMiTlhWifG3lw81dfy8EGO68cTn9w7l2VH1zSE5yebdVRLcbmR1mQ3/pub?output=csv';
        const GOOGLE_SHEETS_REPOSICION_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpi3dSS6SW6p6wnas8gS-976rMiTlhWifG3lw81dfy8EGO68cTn9w7l2VH1zSE5yebdVRLcbmR1mQ3/pub?output=csv';

        // CONTRASE√ëA PARA SUBIR SLOTING
        const PASSWORD_SLOTING = 'E123456';

        // ================= INICIALIZAR FIREBASE =================
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ================= VARIABLES GLOBALES =================
        let moduloActual = 'recoleccion';
        let rutasRecoleccionDesdeSheets = {};
        let rutasReposicionDesdeSheets = {};
        let estadoDesdeFirebase = {};
        let registrosRecoleccion = [];
        let registrosReposicion = [];
        let slotingData = {};

        // ================= INICIALIZACI√ìN =================
        window.addEventListener('load', function() {
            inicializarFirebase();
            
            // Establecer fechas por defecto (√∫ltimos 7 d√≠as)
            const hoy = new Date();
            const haceSieteDias = new Date();
            haceSieteDias.setDate(hoy.getDate() - 7);
            
            document.getElementById('fechaInicioRecoleccion').value = haceSieteDias.toISOString().split('T')[0];
            document.getElementById('fechaFinRecoleccion').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicioReposicion').value = haceSieteDias.toISOString().split('T')[0];
            document.getElementById('fechaFinReposicion').value = hoy.toISOString().split('T')[0];
            
            cargarDashboard();
            cargarSlotingDesdeFirebase();
        });

        // ================= CONEXIONES FIREBASE Y SHEETS =================
        function inicializarFirebase() {
            try {
                verificarConexionFirebase();
                verificarConexionSheets();
            } catch (error) {
                document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
            }
        }

        function verificarConexionFirebase() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator connected';
                } else {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
                }
            });
        }

        async function verificarConexionSheets() {
            try {
                // Verificar conexi√≥n a Sheets de recolecci√≥n
                const response = await fetch(GOOGLE_SHEETS_RECOLECCION_URL);
                if (response.ok) {
                    document.getElementById('sheetsIndicator').className = 'connection-indicator connected';
                } else {
                    document.getElementById('sheetsIndicator').className = 'connection-indicator disconnected';
                }
            } catch (error) {
                document.getElementById('sheetsIndicator').className = 'connection-indicator disconnected';
            }
        }

        // ================= CAMBIO DE M√ìDULO - MEJORADO SIN PARPADEO =================
        function cambiarModulo(modulo, boton) {
            moduloActual = modulo;
            
            // Actualizar pesta√±as activas - MEJORADO
            document.querySelectorAll('.module-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            boton.classList.add('active');
            
            // Mostrar/ocultar paneles seg√∫n el m√≥dulo
            if (modulo === 'sloting') {
                document.getElementById('adminMainPanel').classList.add('hidden');
                document.getElementById('adminSlotingPanel').classList.remove('hidden');
                document.getElementById('routesPanel').classList.add('hidden');
                document.getElementById('reportsPanel').classList.add('hidden');
                document.getElementById('slotingPanel').classList.remove('hidden');
            } else {
                document.getElementById('adminMainPanel').classList.remove('hidden');
                document.getElementById('adminSlotingPanel').classList.add('hidden');
                document.getElementById('routesPanel').classList.remove('hidden');
                document.getElementById('reportsPanel').classList.remove('hidden');
                document.getElementById('slotingPanel').classList.add('hidden');
                
                // Actualizar t√≠tulo del panel
                document.getElementById('panelTitulo').textContent = 
                    `Estado de Rutas - ${modulo === 'recoleccion' ? 'Recolecci√≥n' : 'Reposici√≥n'}`;
                
                // Recargar datos del m√≥dulo seleccionado
                cargarDashboard();
            }
        }

        // ================= GESTI√ìN DE SLOTING - CON CONTRASE√ëA =================
        function solicitarSubirSloting() {
            document.getElementById('slotingModal').style.display = 'flex';
            document.getElementById('uploadProgressBar').style.display = 'none';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('slotingFile').value = '';
            document.getElementById('slotingPassword').value = '';
        }

        function cerrarSlotingModal() {
            document.getElementById('slotingModal').style.display = 'none';
        }

        async function procesarSloting() {
            const fileInput = document.getElementById('slotingFile');
            const file = fileInput.files[0];
            const password = document.getElementById('slotingPassword').value;
            
            // VERIFICAR CONTRASE√ëA
            if (password !== PASSWORD_SLOTING) {
                mostrarMensaje('‚ùå Contrase√±a incorrecta. No tienes permisos para subir sloting.', false);
                return;
            }
            
            if (!file) {
                mostrarMensaje('Por favor, selecciona un archivo CSV', false);
                return;
            }
            
            // Mostrar progreso
            document.getElementById('uploadProgressBar').style.display = 'block';
            document.getElementById('uploadProgressFill').style.width = '10%';
            document.getElementById('uploadStatus').textContent = 'Leyendo archivo...';
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    document.getElementById('uploadProgressFill').style.width = '30%';
                    document.getElementById('uploadStatus').textContent = 'Procesando datos...';
                    
                    // Procesar CSV
                    const datosProcesados = procesarCSVSloting(csvText);
                    document.getElementById('uploadProgressFill').style.width = '60%';
                    document.getElementById('uploadStatus').textContent = 'Subiendo a Firebase...';
                    
                    // Subir a Firebase - CON MANEJO DE ERRORES MEJORADO
                    try {
                        await database.ref('sloting').set(datosProcesados);
                        
                        document.getElementById('uploadProgressFill').style.width = '100%';
                        document.getElementById('uploadStatus').textContent = '‚úÖ Sloting subido correctamente';
                        
                        // Actualizar informaci√≥n del sloting
                        setTimeout(() => {
                            cerrarSlotingModal();
                            cargarSlotingDesdeFirebase();
                            mostrarMensaje(`‚úÖ Sloting actualizado correctamente. ${Object.keys(datosProcesados).length} registros procesados.`, true);
                        }, 1000);
                        
                    } catch (firebaseError) {
                        console.error('Error de Firebase:', firebaseError);
                        if (firebaseError.code === 'PERMISSION_DENIED') {
                            document.getElementById('uploadStatus').textContent = '‚ùå Error: Permisos denegados en Firebase. Verifica las reglas de la base de datos.';
                            mostrarMensaje('‚ùå Error: Permisos denegados. Contacta al administrador para actualizar las reglas de Firebase.', false);
                        } else {
                            document.getElementById('uploadStatus').textContent = `‚ùå Error de Firebase: ${firebaseError.message}`;
                            mostrarMensaje(`‚ùå Error al subir sloting: ${firebaseError.message}`, false);
                        }
                        document.getElementById('uploadProgressFill').style.width = '0%';
                    }
                    
                } catch (error) {
                    console.error('Error procesando sloting:', error);
                    document.getElementById('uploadStatus').textContent = `‚ùå Error: ${error.message}`;
                    document.getElementById('uploadProgressFill').style.width = '0%';
                    mostrarMensaje(`‚ùå Error procesando archivo: ${error.message}`, false);
                }
            };
            
            reader.onerror = function() {
                document.getElementById('uploadStatus').textContent = '‚ùå Error al leer el archivo';
                document.getElementById('uploadProgressFill').style.width = '0%';
                mostrarMensaje('‚ùå Error al leer el archivo seleccionado', false);
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function procesarCSVSloting(csvText) {
            const datos = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                throw new Error('El archivo CSV est√° vac√≠o');
            }
            
            // Detectar separador
            const primeraLinea = lineas[0];
            const separador = primeraLinea.includes('\t') ? '\t' : ',';
            
            // Verificar encabezados
            const encabezados = primeraLinea.split(separador).map(h => h.trim().replace(/^"|"$/g, ''));
            
            if (encabezados.length < 3 || 
                !encabezados[0].includes('UPC') || 
                !encabezados[1].includes('ARTICULO') || 
                !encabezados[2].includes('DEPOSITO')) {
                throw new Error('Formato de archivo incorrecto. Se esperaban columnas: CODIGO_UPC, ARTICULO, DEPOSITO FINAL');
            }
            
            // Procesar datos
            let registrosProcesados = 0;
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 3) {
                    const upc = partes[0];
                    const articulo = partes[1];
                    const deposito = partes[2];
                    
                    if (upc && articulo && deposito) {
                        datos[upc] = {
                            articulo: articulo,
                            deposito: deposito
                        };
                        registrosProcesados++;
                    }
                }
            }
            
            if (registrosProcesados === 0) {
                throw new Error('No se encontraron datos v√°lidos en el archivo');
            }
            
            return datos;
        }

        async function cargarSlotingDesdeFirebase() {
            try {
                const snapshot = await database.ref('sloting').once('value');
                slotingData = snapshot.val() || {};
                
                // Actualizar informaci√≥n en la UI
                document.getElementById('slotingTotalRecords').textContent = Object.keys(slotingData).length;
                
                if (Object.keys(slotingData).length > 0) {
                    document.getElementById('slotingStatus').textContent = 'Datos cargados';
                    document.getElementById('slotingStatus').style.color = '#27ae60';
                    document.getElementById('slotingLastUpdate').textContent = new Date().toLocaleString();
                    
                    // Mostrar vista previa
                    mostrarVistaPreviaSloting();
                } else {
                    document.getElementById('slotingStatus').textContent = 'No hay datos cargados';
                    document.getElementById('slotingStatus').style.color = '#e74c3c';
                    document.getElementById('slotingPreview').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error cargando sloting:', error);
                document.getElementById('slotingStatus').textContent = 'Error al cargar datos';
                document.getElementById('slotingStatus').style.color = '#e74c3c';
            }
        }

        function mostrarVistaPreviaSloting() {
            const previewBody = document.getElementById('slotingPreviewBody');
            previewBody.innerHTML = '';
            
            const upcs = Object.keys(slotingData);
            const registrosMostrar = Math.min(5, upcs.length);
            
            for (let i = 0; i < registrosMostrar; i++) {
                const upc = upcs[i];
                const registro = slotingData[upc];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${upc}</td>
                    <td>${registro.articulo}</td>
                    <td>${registro.deposito}</td>
                `;
                previewBody.appendChild(row);
            }
            
            document.getElementById('slotingPreview').style.display = 'block';
        }

        function verificarSlotingActual() {
            if (Object.keys(slotingData).length === 0) {
                mostrarMensaje('No hay datos de sloting cargados', false);
                return;
            }
            
            cargarSlotingDesdeFirebase();
            mostrarMensaje(`Sloting cargado: ${Object.keys(slotingData).length} registros`, true);
        }

        function descargarBackupSloting() {
            if (Object.keys(slotingData).length === 0) {
                mostrarMensaje('No hay datos de sloting para descargar', false);
                return;
            }
            
            let csvContent = "CODIGO_UPC,ARTICULO,DEPOSITO FINAL\n";
            
            Object.keys(slotingData).forEach(upc => {
                const registro = slotingData[upc];
                csvContent += `"${upc}","${registro.articulo}","${registro.deposito}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_sloting_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarMensaje(`‚úÖ Backup descargado (${Object.keys(slotingData).length} registros)`, true);
        }

        // ================= FUNCIONES ORIGINALES DEL ADMINISTRADOR =================
        // [Las funciones restantes se mantienen igual que en tu c√≥digo original]
        // Solo se modificaron las funciones relacionadas con sloting y cambio de m√≥dulo
        
        async function cargarDashboard() {
            try {
                mostrarMensaje('Cargando datos del sistema...', true);
                
                // Cargar datos de Firebase
                await cargarDatosFirebase();
                
                // Cargar datos de Sheets seg√∫n el m√≥dulo
                if (moduloActual === 'recoleccion') {
                    await cargarDatosSheetsRecoleccion();
                } else {
                    await cargarDatosSheetsReposicion();
                }
                
                // Procesar y mostrar datos
                actualizarEstadisticas();
                actualizarTablaEstadoRutas();
                
                mostrarMensaje('Dashboard actualizado correctamente', true);
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                mostrarMensaje('Error al cargar el dashboard: ' + error.message, false);
            }
        }

        async function cargarDatosFirebase() {
            return new Promise((resolve, reject) => {
                // Cargar estado de rutas desde Firebase
                database.ref('estado').once('value')
                    .then(snapshot => {
                        estadoDesdeFirebase = snapshot.val() || {};
                        console.log('Estado cargado desde Firebase:', estadoDesdeFirebase);
                        
                        // Cargar registros de recolecci√≥n
                        return database.ref('recolecciones').once('value');
                    })
                    .then(snapshot => {
                        const registros = snapshot.val();
                        registrosRecoleccion = registros ? Object.values(registros) : [];
                        console.log('Registros de recolecci√≥n cargados:', registrosRecoleccion.length);
                        
                        // Cargar registros de reposici√≥n (si existen)
                        return database.ref('reposiciones').once('value');
                    })
                    .then(snapshot => {
                        const registros = snapshot.val();
                        registrosReposicion = registros ? Object.values(registros) : [];
                        console.log('Registros de reposici√≥n cargados:', registrosReposicion.length);
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error cargando datos de Firebase:', error);
                        reject(error);
                    });
            });
        }

        async function cargarDatosSheetsRecoleccion() {
            try {
                const response = await fetch(GOOGLE_SHEETS_RECOLECCION_URL);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo cargar desde Google Sheets`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('error') || csvText.length < 10) {
                    throw new Error('No hay datos en Google Sheets o la hoja no es accesible');
                }
                
                rutasRecoleccionDesdeSheets = procesarCSVRecoleccion(csvText);
                console.log('Datos de recolecci√≥n cargados desde Sheets:', rutasRecoleccionDesdeSheets);
                
            } catch (error) {
                console.error('Error cargando datos de recolecci√≥n de Sheets:', error);
                throw new Error('No se pudo conectar con Google Sheets Recolecci√≥n: ' + error.message);
            }
        }

        async function cargarDatosSheetsReposicion() {
            try {
                const response = await fetch(GOOGLE_SHEETS_REPOSICION_URL);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo cargar desde Google Sheets`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('error') || csvText.length < 10) {
                    throw new Error('No hay datos en Google Sheets o la hoja no es accesible');
                }
                
                rutasReposicionDesdeSheets = procesarCSVReposicion(csvText);
                console.log('Datos de reposici√≥n cargados desde Sheets:', rutasReposicionDesdeSheets);
                
            } catch (error) {
                console.error('Error cargando datos de reposici√≥n de Sheets:', error);
                throw new Error('No se pudo conectar con Google Sheets Reposici√≥n: ' + error.message);
            }
        }

        function procesarCSVRecoleccion(csvText) {
            const rutas = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                return {};
            }
            
            const separador = csvText.includes('\t') ? '\t' : ',';
            
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 4) {
                    const deposito = partes[0];
                    const upc = partes[1];
                    const descripcion = partes[2];
                    const cantidad = parseInt(partes[3]) || 0;
                    
                    if (deposito && upc) {
                        // Procesar formato: A01-005-B0056
                        const match = deposito.match(/^A(\d+)-/);
                        if (match) {
                            const rutaNum = match[1].padStart(2, '0');
                            const ruta = `Ruta ${rutaNum}`;
                            
                            // Determinar cola por nivel (B, CDE, F)
                            let cola = 'N/A';
                            if (deposito.includes('-B')) cola = 'B';
                            else if (deposito.includes('-C') || deposito.includes('-D') || deposito.includes('-E')) cola = 'CDE';
                            else if (deposito.includes('-F')) cola = 'F';
                            
                            if (!rutas[ruta]) {
                                rutas[ruta] = {};
                            }
                            if (!rutas[ruta][cola]) {
                                rutas[ruta][cola] = {
                                    totalUnidades: 0,
                                    depositos: []
                                };
                            }
                            
                            rutas[ruta][cola].totalUnidades += cantidad;
                            rutas[ruta][cola].depositos.push({
                                deposito,
                                upc,
                                descripcion,
                                cantidad
                            });
                        }
                    }
                }
            }
            
            return rutas;
        }

        function procesarCSVReposicion(csvText) {
            const rutas = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                return {};
            }
            
            const separador = csvText.includes('\t') ? '\t' : ',';
            
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 4) {
                    const deposito = partes[0];
                    const upc = partes[1];
                    const descripcion = partes[2];
                    const cantidad = parseInt(partes[3]) || 0;
                    
                    if (deposito && upc) {
                        // Procesar formatos: P01-005-A y 8-009-2-A
                        let rutaNum, cola;
                        
                        if (deposito.startsWith('P')) {
                            // Formato: P01-005-A
                            const match = deposito.match(/^P(\d+)-/);
                            if (match) {
                                rutaNum = match[1].padStart(2, '0');
                                cola = deposito.split('-').pop(); // √öltima letra
                            }
                        } else if (/^\d+-/.test(deposito)) {
                            // Formato: 8-009-2-A
                            const match = deposito.match(/^(\d+)-/);
                            if (match) {
                                rutaNum = match[1].padStart(2, '0');
                                cola = deposito.split('-').pop(); // √öltima letra
                            }
                        }
                        
                        if (rutaNum && cola) {
                            const ruta = `Ruta ${rutaNum}`;
                            
                            if (!rutas[ruta]) {
                                rutas[ruta] = {};
                            }
                            if (!rutas[ruta][cola]) {
                                rutas[ruta][cola] = {
                                    totalUnidades: 0,
                                    depositos: []
                                };
                            }
                            
                            rutas[ruta][cola].totalUnidades += cantidad;
                            rutas[ruta][cola].depositos.push({
                                deposito,
                                upc,
                                descripcion,
                                cantidad
                            });
                        }
                    }
                }
            }
            
            return rutas;
        }

        function actualizarEstadisticas() {
            let rutasActivas, rutasCompletadas, operariosUnicos, totalRegistros;
            
            if (moduloActual === 'recoleccion') {
                rutasActivas = Object.keys(rutasRecoleccionDesdeSheets).length;
                rutasCompletadas = calcularRutasCompletadasRecoleccion();
                operariosUnicos = new Set();
                totalRegistros = registrosRecoleccion.length;
                
                registrosRecoleccion.forEach(registro => {
                    if (registro.usuario) operariosUnicos.add(registro.usuario);
                });
            } else {
                rutasActivas = Object.keys(rutasReposicionDesdeSheets).length;
                rutasCompletadas = calcularRutasCompletadasReposicion();
                operariosUnicos = new Set();
                totalRegistros = registrosReposicion.length;
                
                registrosReposicion.forEach(registro => {
                    if (registro.usuario) operariosUnicos.add(registro.usuario);
                });
            }
            
            // Actualizar UI
            document.getElementById('totalRutas').textContent = rutasActivas;
            document.getElementById('rutasCompletadas').textContent = rutasCompletadas;
            document.getElementById('totalOperarios').textContent = operariosUnicos.size;
            document.getElementById('totalRegistros').textContent = totalRegistros;
        }

        function calcularRutasCompletadasRecoleccion() {
            let completadas = 0;
            Object.keys(rutasRecoleccionDesdeSheets).forEach(ruta => {
                Object.keys(rutasRecoleccionDesdeSheets[ruta]).forEach(cola => {
                    const progreso = calcularProgresoRecoleccion(ruta, cola);
                    if (progreso.porcentaje === 100) completadas++;
                });
            });
            return completadas;
        }

        function calcularRutasCompletadasReposicion() {
            let completadas = 0;
            Object.keys(rutasReposicionDesdeSheets).forEach(ruta => {
                Object.keys(rutasReposicionDesdeSheets[ruta]).forEach(cola => {
                    const progreso = calcularProgresoReposicion(ruta, cola);
                    if (progreso.porcentaje === 100) completadas++;
                });
            });
            return completadas;
        }

        function actualizarTablaEstadoRutas() {
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = '';
            
            let datos;
            if (moduloActual === 'recoleccion') {
                datos = rutasRecoleccionDesdeSheets;
            } else {
                datos = rutasReposicionDesdeSheets;
            }
            
            if (Object.keys(datos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No hay datos disponibles para este m√≥dulo</td></tr>';
            } else {
                Object.keys(datos).forEach(ruta => {
                    Object.keys(datos[ruta]).forEach(cola => {
                        let progreso, estadoClass, estadoText, recolector, ultimaActualizacion;
                        
                        if (moduloActual === 'recoleccion') {
                            progreso = calcularProgresoRecoleccion(ruta, cola);
                        } else {
                            progreso = calcularProgresoReposicion(ruta, cola);
                        }
                        
                        // Determinar estado
                        if (progreso.porcentaje === 100) {
                            estadoClass = 'status-completed';
                            estadoText = 'COMPLETADA';
                        } else if (progreso.porcentaje > 0) {
                            estadoClass = 'status-in-progress';
                            estadoText = 'EN PROGRESO';
                        } else {
                            estadoClass = 'status-pending';
                            estadoText = 'PENDIENTE';
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ruta}</td>
                            <td>${cola}</td>
                            <td class="${estadoClass}">${estadoText}</td>
                            <td>${progreso.recolector || '-'}</td>
                            <td>${progreso.completado}/${progreso.total} (${progreso.porcentaje}%)</td>
                            <td>${progreso.ultimaActualizacion || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            }
            
            document.getElementById('dashboardLoading').style.display = 'none';
            document.getElementById('dashboardTable').style.display = 'table';
        }

        function calcularProgresoRecoleccion(ruta, cola) {
            const datosSheets = rutasRecoleccionDesdeSheets[ruta][cola];
            const total = datosSheets.totalUnidades;
            let completado = 0;
            let recolector = '';
            let ultimaActualizacion = '';
            
            // Calcular progreso basado en registros de Firebase
            datosSheets.depositos.forEach(deposito => {
                const registrosDeposito = registrosRecoleccion.filter(reg => 
                    reg.deposito === deposito.deposito && reg.accion === 'escaneado'
                );
                
                if (registrosDeposito.length > 0) {
                    completado += Math.min(deposito.cantidad, registrosDeposito[0].recolectado || 0);
                    
                    // Obtener info del √∫ltimo recolector
                    const ultimoRegistro = registrosDeposito[registrosDeposito.length - 1];
                    if (ultimoRegistro.usuario && !recolector) {
                        recolector = ultimoRegistro.usuario;
                    }
                    if (ultimoRegistro.timestamp && !ultimaActualizacion) {
                        ultimaActualizacion = new Date(ultimoRegistro.timestamp).toLocaleString();
                    }
                }
            });
            
            const porcentaje = total > 0 ? Math.round((completado / total) * 100) : 0;
            
            return {
                completado,
                total,
                porcentaje,
                recolector,
                ultimaActualizacion
            };
        }

        function calcularProgresoReposicion(ruta, cola) {
            const datosSheets = rutasReposicionDesdeSheets[ruta][cola];
            const total = datosSheets.totalUnidades;
            let completado = 0;
            let recolector = '';
            let ultimaActualizacion = '';
            
            // Calcular progreso basado en registros de Firebase
            datosSheets.depositos.forEach(deposito => {
                const registrosDeposito = registrosReposicion.filter(reg => 
                    reg.deposito === deposito.deposito
                );
                
                if (registrosDeposito.length > 0) {
                    completado += deposito.cantidad; // Asumimos que si hay registro, est√° completo
                    
                    // Obtener info del √∫ltimo recolector
                    const ultimoRegistro = registrosDeposito[registrosDeposito.length - 1];
                    if (ultimoRegistro.usuario && !recolector) {
                        recolector = ultimoRegistro.usuario;
                    }
                    if (ultimoRegistro.timestamp && !ultimaActualizacion) {
                        ultimaActualizacion = new Date(ultimoRegistro.timestamp).toLocaleString();
                    }
                }
            });
            
            const porcentaje = total > 0 ? Math.round((completado / total) * 100) : 0;
            
            return {
                completado,
                total,
                porcentaje,
                recolector,
                ultimaActualizacion
            };
        }

        async function verificarConsistencia() {
            try {
                mostrarMensaje('Verificando consistencia entre Sheets y Firebase...', true);
                
                await cargarDatosSheetsRecoleccion();
                await cargarDatosSheetsReposicion();
                await cargarDatosFirebase();
                
                const inconsistencias = encontrarInconsistencias();
                mostrarResultadosConsistencia(inconsistencias);
                
            } catch (error) {
                console.error('Error en verificaci√≥n de consistencia:', error);
                mostrarMensaje('Error en verificaci√≥n de consistencia: ' + error.message, false);
            }
        }

        function encontrarInconsistencias() {
            const inconsistencias = [];
            
            // Verificar recolecci√≥n
            Object.keys(rutasRecoleccionDesdeSheets).forEach(ruta => {
                Object.keys(rutasRecoleccionDesdeSheets[ruta]).forEach(cola => {
                    const datosSheets = rutasRecoleccionDesdeSheets[ruta][cola];
                    const progreso = calcularProgresoRecoleccion(ruta, cola);
                    
                    if (progreso.completado > datosSheets.totalUnidades) {
                        inconsistencias.push({
                            modulo: 'Recolecci√≥n',
                            ruta,
                            cola,
                            tipo: 'SOBREPROGRESO',
                            descripcion: `Progreso en Firebase (${progreso.completado}) excede el total en Sheets (${datosSheets.totalUnidades})`
                        });
                    }
                });
            });
            
            // Verificar reposici√≥n
            Object.keys(rutasReposicionDesdeSheets).forEach(ruta => {
                Object.keys(rutasReposicionDesdeSheets[ruta]).forEach(cola => {
                    const datosSheets = rutasReposicionDesdeSheets[ruta][cola];
                    const progreso = calcularProgresoReposicion(ruta, cola);
                    
                    if (progreso.completado > datosSheets.totalUnidades) {
                        inconsistencias.push({
                            modulo: 'Reposici√≥n',
                            ruta,
                            cola,
                            tipo: 'SOBREPROGRESO',
                            descripcion: `Progreso en Firebase (${progreso.completado}) excede el total en Sheets (${datosSheets.totalUnidades})`
                        });
                    }
                });
            });
            
            return inconsistencias;
        }

        function mostrarResultadosConsistencia(inconsistencias) {
            const container = document.getElementById('consistencyContent');
            const resultsDiv = document.getElementById('consistencyResults');
            
            if (inconsistencias.length === 0) {
                container.innerHTML = '<p style="color: green;">‚úÖ No se encontraron inconsistencias. Los datos est√°n sincronizados.</p>';
            } else {
                let html = `<p><strong>Se encontraron ${inconsistencias.length} inconsistencias:</strong></p>`;
                html += '<ul style="text-align: left; margin: 15px 0;">';
                
                inconsistencias.forEach(inc => {
                    html += `<li style="margin-bottom: 8px; color: orange;">
                        <strong>${inc.modulo} - ${inc.ruta} - ${inc.cola}</strong> (${inc.tipo}): ${inc.descripcion}
                    </li>`;
                });
                
                html += '</ul>';
                container.innerHTML = html;
            }
            
            resultsDiv.classList.remove('hidden');
            mostrarMensaje(`Verificaci√≥n completada: ${inconsistencias.length} inconsistencias encontradas`, inconsistencias.length === 0);
        }

        async function actualizarDesdeSheets() {
            try {
                mostrarMensaje('Actualizando desde Google Sheets...', true);
                
                await cargarDatosSheetsRecoleccion();
                await cargarDatosSheetsReposicion();
                await verificarConexionSheets();
                
                // Actualizar la vista
                actualizarEstadisticas();
                actualizarTablaEstadoRutas();
                
                mostrarMensaje('‚úÖ Datos actualizados desde Google Sheets correctamente', true);
                
            } catch (error) {
                console.error('Error actualizando desde Sheets:', error);
                mostrarMensaje('‚ùå Error al actualizar desde Sheets: ' + error.message, false);
            }
        }

        async function descargarReporteRecoleccion() {
            try {
                const fechaInicio = document.getElementById('fechaInicioRecoleccion').value;
                const fechaFin = document.getElementById('fechaFinRecoleccion').value;
                
                if (!fechaInicio || !fechaFin) {
                    mostrarMensaje('Por favor, selecciona ambas fechas', false);
                    return;
                }
                
                mostrarMensaje('Generando reporte de recolecci√≥n...', true);
                
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                fin.setHours(23, 59, 59, 999);
                
                const registrosFiltrados = registrosRecoleccion.filter(reg => {
                    const fechaReg = new Date(reg.timestamp);
                    return fechaReg >= inicio && fechaReg <= fin;
                });
                
                if (registrosFiltrados.length === 0) {
                    mostrarMensaje('No hay registros en el rango de fechas seleccionado', false);
                    return;
                }
                
                generarCSVRecoleccion(registrosFiltrados, fechaInicio, fechaFin);
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                mostrarMensaje('Error al generar reporte: ' + error.message, false);
            }
        }

        function generarCSVRecoleccion(registros, fechaInicio, fechaFin) {
            let csvContent = "USUARIO,RUTA,COLA,DEPOSITO,UPC,DESCRIPCION,CANTIDAD_PLANIFICADA,CANTIDAD_RECOLECTADA,ACCION,FECHA,HORA,TIMESTAMP\n";
            
            registros.forEach(reg => {
                const fecha = reg.fecha || new Date(reg.timestamp).toLocaleDateString();
                const hora = reg.hora || new Date(reg.timestamp).toLocaleTimeString();
                
                csvContent += `"${reg.usuario || ''}","${reg.ruta || ''}","${reg.cola || ''}","${reg.deposito || ''}","${reg.upc || ''}","${reg.descripcion || ''}",${reg.cantidad || 0},${reg.recolectado || 0},"${reg.accion || ''}","${fecha}","${hora}",${reg.timestamp || ''}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_recoleccion_${fechaInicio}_${fechaFin}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarMensaje(`‚úÖ Reporte de recolecci√≥n descargado (${registros.length} registros)`, true);
        }

        async function descargarReporteReposicion() {
            try {
                const fechaInicio = document.getElementById('fechaInicioReposicion').value;
                const fechaFin = document.getElementById('fechaFinReposicion').value;
                
                if (!fechaInicio || !fechaFin) {
                    mostrarMensaje('Por favor, selecciona ambas fechas', false);
                    return;
                }
                
                mostrarMensaje('Generando reporte de reposici√≥n...', true);
                
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                fin.setHours(23, 59, 59, 999);
                
                const registrosFiltrados = registrosReposicion.filter(reg => {
                    const fechaReg = new Date(reg.timestamp || Date.now());
                    return fechaReg >= inicio && fechaReg <= fin;
                });
                
                if (registrosFiltrados.length === 0) {
                    mostrarMensaje('No hay registros de reposici√≥n en el rango de fechas seleccionado', false);
                    return;
                }
                
                generarCSVReposicion(registrosFiltrados, fechaInicio, fechaFin);
                
            } catch (error) {
                console.error('Error generando reporte de reposici√≥n:', error);
                mostrarMensaje('Error al generar reporte de reposici√≥n: ' + error.message, false);
            }
        }

        function generarCSVReposicion(registros, fechaInicio, fechaFin) {
            let csvContent = "USUARIO,RUTA,COLA,DEPOSITO,UPC,DESCRIPCION,CANTIDAD,FECHA,HORA,TIMESTAMP\n";
            
            registros.forEach(reg => {
                const fecha = reg.fecha || new Date(reg.timestamp).toLocaleDateString();
                const hora = reg.hora || new Date(reg.timestamp).toLocaleTimeString();
                
                csvContent += `"${reg.usuario || ''}","${reg.ruta || ''}","${reg.cola || ''}","${reg.deposito || ''}","${reg.upc || ''}","${reg.descripcion || ''}",${reg.cantidad || 0},"${fecha}","${hora}",${reg.timestamp || ''}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_reposicion_${fechaInicio}_${fechaFin}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarMensaje(`‚úÖ Reporte de reposici√≥n descargado (${registros.length} registros)`, true);
        }

        function volverInterfazPrincipal() {
            window.location.href = 'index.html';
        }

        function mostrarMensaje(mensaje, esExito) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = esExito ? 'status-message success-message' : 'status-message error-message';
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Actualizar autom√°ticamente cada 2 minutos
        setInterval(() => {
            cargarDashboard();
        }, 120000);
    </script>
</body>
</html>