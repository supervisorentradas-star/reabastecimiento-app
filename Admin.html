<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - REABASTECIMIENTO SOKSO</title>
    <!-- Librer√≠a para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: white;
            padding: 20px;
            color: black;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        h1 {
            color: #6600a1;
            font-size: 28px;
            margin-bottom: 15px;
        }
        h2 {
            color: #6600a1;
            font-size: 22px;
            margin-bottom: 15px;
        }
        .connection-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }
        .connection-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: bold;
        }
        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .connected {
            background-color: #27ae60;
        }
        .disconnected {
            background-color: #e74c3c;
        }
        .checking {
            background-color: #f39c12;
        }
        .module-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .module-tab {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            top: 0;
        }
        .module-tab.active {
            background: #6600a1;
            color: white;
            border: 2px solid #6600a1;
        }
        .module-tab:hover {
            background: #e0e0e0;
        }
        .module-tab.active:hover {
            background: #55008a;
            border-color: #55008a;
        }
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .admin-button {
            background: #6600a1;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .admin-button:hover {
            background: #55008a;
        }
        .admin-button.warning {
            background: #f39c12;
        }
        .admin-button.warning:hover {
            background: #e67e22;
        }
        .admin-button.success {
            background: #27ae60;
        }
        .admin-button.success:hover {
            background: #219653;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 15px;
        }
        .dashboard-table th, .dashboard-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .dashboard-table th {
            background: #6600a1;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .status-in-progress {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        .status-pending {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        .report-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-item label {
            font-size: 14px;
            font-weight: bold;
        }
        .filter-item input {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .back-button {
            background: #6600a1;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .back-button:hover {
            background: #55008a;
        }
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            display: none;
            font-size: 14px;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #6600a1;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .consistency-check {
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }
        .hidden {
            display: none;
        }
        /* Estilos para modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal h3 {
            color: #6600a1;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .modal p {
            margin-bottom: 15px;
            color: #333;
            font-size: 14px;
        }
        input[type="password"], input[type="file"], select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .modal-button.success {
            background: #6600a1;
            color: white;
        }
        .modal-button.warning {
            background: #f0f0f0;
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        .file-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            text-align: left;
        }
        .password-field {
            margin: 15px 0;
        }
        .upload-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .upload-mode {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .upload-mode.selected {
            border-color: #6600a1;
            background: #f0e6f5;
            color: #6600a1;
        }
        .quick-date-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        .quick-date-button {
            background: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .quick-date-button:hover {
            background: #d0d0d0;
        }
        .quick-date-button.active {
            background: #6600a1;
            color: white;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin - REABASTECIMIENTO SOKSO</h1>
            <div class="connection-status">
                <div class="connection-item">
                    <div id="firebaseIndicator" class="connection-indicator checking"></div>
                    <span>FIREBASE</span>
                </div>
            </div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- SELECTOR DE M√ìDULO -->
        <div class="module-selector">
            <button class="module-tab active" onclick="cambiarModulo('recoleccion', this)">üì¶ Recolecci√≥n</button>
            <button class="module-tab" onclick="cambiarModulo('reposicion', this)">üîÑ Reposici√≥n</button>
            <button class="module-tab" onclick="cambiarModulo('rutas', this)">üìã RUTAS & COLAS</button>
            <button class="module-tab" onclick="cambiarModulo('sloting', this)">üì§ Gesti√≥n Sloting</button>
        </div>

        <!-- ESTAD√çSTICAS R√ÅPIDAS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRutas">0</div>
                <div class="stat-label">Rutas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rutasCompletadas">0</div>
                <div class="stat-label">Rutas Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalOperarios">0</div>
                <div class="stat-label">Operarios Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRegistros">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
        </div>

        <!-- CONTROLES ADMIN - PANEL PRINCIPAL -->
        <div id="adminMainPanel" class="admin-controls">
            <button class="admin-button" onclick="actualizarDesdeFirebase()">üîÑ Actualizar desde Firebase</button>
            <button class="admin-button" onclick="cargarDashboard()">üìä Actualizar Panel</button>
        </div>

        <!-- CONTROLES ADMIN - PANEL RUTAS & COLAS -->
        <div id="adminRutasPanel" class="admin-controls hidden">
            <button class="admin-button success" onclick="solicitarSubirRutas('recoleccion')">üì§ Subir Recolecci√≥n</button>
            <button class="admin-button warning" onclick="verificarRutasActuales()">üîç Ver Rutas Actuales</button>
        </div>

        <!-- CONTROLES ADMIN - PANEL SLOTING -->
        <div id="adminSlotingPanel" class="admin-controls hidden">
            <button class="admin-button success" onclick="solicitarSubirSloting()">üì§ Subir Sloting</button>
        </div>

        <!-- PANEL DE CONTROL - ESTADO DE RUTAS -->
        <div id="routesPanel" class="section">
            <h2 id="panelTitulo">Estado de Rutas - Recolecci√≥n</h2>
            <div id="dashboardLoading" class="loading">Cargando estado de rutas...</div>
            <table class="dashboard-table" id="dashboardTable" style="display:none">
                <thead id="dashboardTableHead">
                    <!-- Se llenar√° din√°micamente seg√∫n el m√≥dulo -->
                </thead>
                <tbody id="dashboardTableBody">
                    <!-- Los datos se llenar√°n din√°micamente -->
                </tbody>
            </table>
        </div>

        <!-- PANEL DE RUTAS & COLAS -->
        <div id="rutasPanel" class="section hidden">
            <h2>Gesti√≥n de Rutas & Colas</h2>
            <div class="file-info">
                <strong>Estado de Recolecci√≥n:</strong> <span id="recoleccionStatus">No hay datos cargados</span><br>
                <strong>√öltima actualizaci√≥n:</strong> <span id="recoleccionLastUpdate">-</span><br>
                <strong>Total de registros:</strong> <span id="recoleccionTotalRecords">0</span>
            </div>
            
            <div id="recoleccionPreview" style="margin-top: 15px; display: none;">
                <h3>Vista Previa de Recolecci√≥n</h3>
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>DEPOSITO</th>
                            <th>CODIGO UPC</th>
                            <th>ARTICULO</th>
                            <th>CANTIDAD</th>
                            <th>INDICADOR</th>
                        </tr>
                    </thead>
                    <tbody id="recoleccionPreviewBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANEL DE SLOTING -->
        <div id="slotingPanel" class="section hidden">
            <h2>Gesti√≥n de Sloting</h2>
            <div id="slotingInfo" class="file-info">
                <strong>Estado del Sloting:</strong> <span id="slotingStatus">No hay datos cargados</span><br>
                <strong>√öltima actualizaci√≥n:</strong> <span id="slotingLastUpdate">-</span><br>
                <strong>Total de registros:</strong> <span id="slotingTotalRecords">0</span>
            </div>
            
            <div id="slotingPreview" style="margin-top: 15px; display: none;">
                <h3>Vista Previa del Sloting</h3>
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>CODIGO_UPC</th>
                            <th>ARTICULO</th>
                            <th>DEPOSITO FINAL</th>
                        </tr>
                    </thead>
                    <tbody id="slotingPreviewBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="reportsPanel" class="section">
            <h2>Generar Reportes</h2>
            
            <!-- Reporte de Recolecci√≥n -->
            <div id="reporteRecoleccion">
                <h3>üìä Reporte de Recolecci√≥n</h3>
                
                <!-- Botones r√°pidos de fecha -->
                <div class="quick-date-buttons">
                    <button class="quick-date-button" onclick="establecerRangoHoy('recoleccion')">Hoy</button>
                    <button class="quick-date-button" onclick="establecerRangoAyer('recoleccion')">Ayer</button>
                    <button class="quick-date-button" onclick="establecerRangoEstaSemana('recoleccion')">Esta Semana</button>
                    <button class="quick-date-button" onclick="establecerRangoEsteMes('recoleccion')">Este Mes</button>
                </div>
                
                <div class="report-filters">
                    <div class="filter-item">
                        <label for="fechaInicioRecoleccion">Fecha Inicio:</label>
                        <input type="date" id="fechaInicioRecoleccion">
                    </div>
                    <div class="filter-item">
                        <label for="fechaFinRecoleccion">Fecha Fin:</label>
                        <input type="date" id="fechaFinRecoleccion">
                    </div>
                </div>
                
                <button class="admin-button success" onclick="descargarReporteRecoleccion()" style="width:100%;margin-bottom:15px">
                    üìä Descargar Reporte Recolecci√≥n (Excel)
                </button>
            </div>

            <!-- Reporte de Reposici√≥n -->
            <div id="reporteReposicion">
                <h3>üìã Reporte de Reposici√≥n</h3>
                
                <!-- Botones r√°pidos de fecha -->
                <div class="quick-date-buttons">
                    <button class="quick-date-button" onclick="establecerRangoHoy('reposicion')">Hoy</button>
                    <button class="quick-date-button" onclick="establecerRangoAyer('reposicion')">Ayer</button>
                    <button class="quick-date-button" onclick="establecerRangoEstaSemana('reposicion')">Esta Semana</button>
                    <button class="quick-date-button" onclick="establecerRangoEsteMes('reposicion')">Este Mes</button>
                </div>
                
                <div class="report-filters">
                    <div class="filter-item">
                        <label for="fechaInicioReposicion">Fecha Inicio:</label>
                        <input type="date" id="fechaInicioReposicion">
                    </div>
                    <div class="filter-item">
                        <label for="fechaFinReposicion">Fecha Fin:</label>
                        <input type="date" id="fechaFinReposicion">
                    </div>
                </div>

                <button class="admin-button success" onclick="descargarReporteReposicion()" style="width:100%">
                    üìã Descargar Reporte Reposici√≥n (Excel)
                </button>
            </div>
        </div>

        <div class="footer">
            <button class="back-button" onclick="volverInterfazPrincipal()">‚Ü©Ô∏è Regresar a Interfaz Principal</button>
        </div>
    </div>

    <!-- MODAL PARA SUBIR RUTAS & COLAS -->
    <div id="rutasModal" class="modal">
        <div class="modal-content">
            <h3 id="rutasModalTitle">Subir Rutas & Colas</h3>
            <p id="rutasModalDescription">Selecciona el archivo CSV con los datos:</p>
            
            <div class="file-info">
                <strong id="rutasFormatoEsperado">Formato esperado:</strong><br>
                <span id="rutasColumnasEsperadas"></span>
            </div>
            
            <!-- Selecci√≥n de modo -->
            <div class="upload-mode-selector">
                <div class="upload-mode selected" id="modeReplace" onclick="seleccionarModo('replace')">
                    üîÑ REEMPLAZAR
                </div>
                <div class="upload-mode" id="modeAdd" onclick="seleccionarModo('add')">
                    ‚ûï A√ëADIR
                </div>
            </div>
            
            <!-- Campo de contrase√±a -->
            <div class="password-field">
                <input type="password" id="rutasPassword" placeholder="Ingresa la contrase√±a (E1)" required>
            </div>
            
            <input type="file" id="rutasFile" accept=".csv">
            
            <div class="progress-bar" id="uploadProgressBar" style="display: none;">
                <div class="progress-fill" id="uploadProgressFill"></div>
            </div>
            
            <div id="uploadStatus" style="margin: 10px 0; font-size: 14px;"></div>
            
            <div class="modal-buttons">
                <button onclick="procesarRutas()" class="modal-button success">Subir Archivo</button>
                <button onclick="cerrarRutasModal()" class="modal-button warning">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SUBIR SLOTING -->
    <div id="slotingModal" class="modal">
        <div class="modal-content">
            <h3>Subir Nuevo Sloting</h3>
            <p>Selecciona el archivo CSV con los datos del sloting:</p>
            
            <div class="file-info">
                <strong>Formato esperado:</strong><br>
                - Columnas: CODIGO_UPC, ARTICULO, DEPOSITO FINAL<br>
                - Separador: coma o tabulaci√≥n<br>
                - Codificaci√≥n: UTF-8
            </div>
            
            <!-- Campo de contrase√±a -->
            <div class="password-field">
                <input type="password" id="slotingPassword" placeholder="Ingresa la contrase√±a (E1)" required>
            </div>
            
            <input type="file" id="slotingFile" accept=".csv">
            
            <div class="progress-bar" id="slotingProgressBar" style="display: none;">
                <div class="progress-fill" id="slotingProgressFill"></div>
            </div>
            
            <div id="slotingUploadStatus" style="margin: 10px 0; font-size: 14px;"></div>
            
            <div class="modal-buttons">
                <button onclick="procesarSloting()" class="modal-button success">Subir Sloting</button>
                <button onclick="cerrarSlotingModal()" class="modal-button warning">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURACI√ìN FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyAl6wzWg_opgBrZ4fe0golJ-fe-civk7RE",
            authDomain: "reabastecimiento-d71a1.firebaseapp.com",
            databaseURL: "https://reabastecimiento-d71a1-default-rtdb.firebaseio.com",
            projectId: "reabastecimiento-d71a1",
            storageBucket: "reabastecimiento-d71a1.firebasestorage.app",
            messagingSenderId: "107012533068",
            appId: "1:107012533068:web:3576d5e3a18a42dcaefde9"
        };

        // CONTRASE√ëAS
        const PASSWORD_SLOTING = 'E123456';
        const PASSWORD_RUTAS = 'E123456';

        // ================= INICIALIZAR FIREBASE =================
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ================= VARIABLES GLOBALES =================
        let moduloActual = 'recoleccion';
        let rutasRecoleccionDesdeFirebase = {};
        let rutasReposicionDesdeFirebase = {};
        let estadoDesdeFirebase = {};
        let registrosRecoleccion = [];
        let registrosReposicion = [];
        let slotingData = {};
        let recoleccionData = {};
        let reposicionData = {};
        
        // Variables para subida de rutas
        let tipoRutaActual = ''; // 'recoleccion' o 'reposicion'
        let modoSubidaActual = 'replace'; // 'replace' o 'add'

        // ================= INICIALIZACI√ìN =================
        window.addEventListener('load', function() {
            inicializarFirebase();
            
            // Establecer fechas por defecto (hoy)
            establecerRangoHoy('recoleccion');
            establecerRangoHoy('reposicion');
            
            cargarDashboard();
            cargarSlotingDesdeFirebase();
            cargarRutasDesdeFirebase();
        });

        // ================= FUNCIONES DE FECHA MEJORADAS =================
        function establecerRangoHoy(tipo) {
            const hoy = new Date().toISOString().split('T')[0];
            if (tipo === 'recoleccion' || tipo === 'ambos') {
                document.getElementById('fechaInicioRecoleccion').value = hoy;
                document.getElementById('fechaFinRecoleccion').value = hoy;
            }
            if (tipo === 'reposicion' || tipo === 'ambos') {
                document.getElementById('fechaInicioReposicion').value = hoy;
                document.getElementById('fechaFinReposicion').value = hoy;
            }
            mostrarMensaje('Rango establecido para hoy', true);
        }

        function establecerRangoAyer(tipo) {
            const ayer = new Date();
            ayer.setDate(ayer.getDate() - 1);
            const fechaAyer = ayer.toISOString().split('T')[0];
            
            if (tipo === 'recoleccion' || tipo === 'ambos') {
                document.getElementById('fechaInicioRecoleccion').value = fechaAyer;
                document.getElementById('fechaFinRecoleccion').value = fechaAyer;
            }
            if (tipo === 'reposicion' || tipo === 'ambos') {
                document.getElementById('fechaInicioReposicion').value = fechaAyer;
                document.getElementById('fechaFinReposicion').value = fechaAyer;
            }
            mostrarMensaje('Rango establecido para ayer', true);
        }

        function establecerRangoEstaSemana(tipo) {
            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay()); // Domingo de esta semana
            
            const fechaInicio = inicioSemana.toISOString().split('T')[0];
            const fechaFin = hoy.toISOString().split('T')[0];
            
            if (tipo === 'recoleccion' || tipo === 'ambos') {
                document.getElementById('fechaInicioRecoleccion').value = fechaInicio;
                document.getElementById('fechaFinRecoleccion').value = fechaFin;
            }
            if (tipo === 'reposicion' || tipo === 'ambos') {
                document.getElementById('fechaInicioReposicion').value = fechaInicio;
                document.getElementById('fechaFinReposicion').value = fechaFin;
            }
            mostrarMensaje('Rango establecido para esta semana', true);
        }

        function establecerRangoEsteMes(tipo) {
            const hoy = new Date();
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            
            const fechaInicio = inicioMes.toISOString().split('T')[0];
            const fechaFin = finMes.toISOString().split('T')[0];
            
            if (tipo === 'recoleccion' || tipo === 'ambos') {
                document.getElementById('fechaInicioRecoleccion').value = fechaInicio;
                document.getElementById('fechaFinRecoleccion').value = fechaFin;
            }
            if (tipo === 'reposicion' || tipo === 'ambos') {
                document.getElementById('fechaInicioReposicion').value = fechaInicio;
                document.getElementById('fechaFinReposicion').value = fechaFin;
            }
            mostrarMensaje('Rango establecido para este mes', true);
        }

        // ================= CONEXI√ìN FIREBASE =================
        function inicializarFirebase() {
            try {
                verificarConexionFirebase();
            } catch (error) {
                document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
            }
        }

        function verificarConexionFirebase() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator connected';
                } else {
                    document.getElementById('firebaseIndicator').className = 'connection-indicator disconnected';
                }
            });
        }

        // ================= CAMBIO DE M√ìDULO =================
        function cambiarModulo(modulo, boton) {
            moduloActual = modulo;
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('.module-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            boton.classList.add('active');
            
            // Mostrar/ocultar paneles seg√∫n el m√≥dulo
            document.getElementById('adminMainPanel').classList.add('hidden');
            document.getElementById('adminRutasPanel').classList.add('hidden');
            document.getElementById('adminSlotingPanel').classList.add('hidden');
            document.getElementById('routesPanel').classList.add('hidden');
            document.getElementById('reportsPanel').classList.add('hidden');
            document.getElementById('rutasPanel').classList.add('hidden');
            document.getElementById('slotingPanel').classList.add('hidden');
            
            if (modulo === 'sloting') {
                document.getElementById('adminSlotingPanel').classList.remove('hidden');
                document.getElementById('slotingPanel').classList.remove('hidden');
                // Ocultar reportes
                document.getElementById('reporteRecoleccion').style.display = 'none';
                document.getElementById('reporteReposicion').style.display = 'none';
            } else if (modulo === 'rutas') {
                document.getElementById('adminRutasPanel').classList.remove('hidden');
                document.getElementById('rutasPanel').classList.remove('hidden');
                // Ocultar reportes
                document.getElementById('reporteRecoleccion').style.display = 'none';
                document.getElementById('reporteReposicion').style.display = 'none';
            } else {
                document.getElementById('adminMainPanel').classList.remove('hidden');
                document.getElementById('routesPanel').classList.remove('hidden');
                document.getElementById('reportsPanel').classList.remove('hidden');
                
                // Actualizar t√≠tulo del panel
                document.getElementById('panelTitulo').textContent = 
                    `Estado de Rutas - ${modulo === 'recoleccion' ? 'Recolecci√≥n' : 'Reposici√≥n'}`;
                
                // Mostrar/ocultar reportes seg√∫n el m√≥dulo
                if (modulo === 'recoleccion') {
                    document.getElementById('reporteRecoleccion').style.display = 'block';
                    document.getElementById('reporteReposicion').style.display = 'none';
                } else if (modulo === 'reposicion') {
                    document.getElementById('reporteRecoleccion').style.display = 'none';
                    document.getElementById('reporteReposicion').style.display = 'block';
                }
                
                // Recargar datos del m√≥dulo seleccionado
                cargarDashboard();
            }
        }

        // ================= FUNCIONES DE AGRUPACI√ìN POR COLAS =================
        
        // Funci√≥n para obtener la cola de recolecci√≥n a partir del dep√≥sito
        function obtenerColaRecoleccion(deposito) {
            if (!deposito) return 'OTROS';
            
            // Ejemplo: "A01-008-F0027" -> extraemos "F"
            const partes = deposito.split('-');
            if (partes.length < 3) return 'OTROS';
            
            const nivel = partes[2].charAt(0); // Tomamos la primera letra del tercer segmento
            
            // Agrupamos seg√∫n las reglas proporcionadas
            if (nivel === 'A' || nivel === 'B') return 'AB';
            if (nivel === 'C' || nivel === 'D' || nivel === 'E') return 'CDE';
            if (nivel === 'F') return 'F';
            
            return 'OTROS';
        }
        
        // Funci√≥n para obtener la cola de reposici√≥n a partir del deposito_destino
        function obtenerColaReposicion(deposito_destino) {
            if (!deposito_destino) return 'OTROS';
            
            // Ejemplo: "P01-005-A" -> extraemos "P01"
            const partes = deposito_destino.split('-');
            if (partes.length < 1) return 'OTROS';
            
            return partes[0]; // Retornamos la primera parte como cola
        }

        // ================= GESTI√ìN DE RUTAS & COLAS =================
        function solicitarSubirRutas(tipo) {
            tipoRutaActual = tipo;
            
            // Configurar el modal seg√∫n el tipo
            if (tipo === 'recoleccion') {
                document.getElementById('rutasModalTitle').textContent = 'Subir Rutas de Recolecci√≥n';
                document.getElementById('rutasModalDescription').textContent = 'Selecciona el archivo CSV con los datos de recolecci√≥n:';
                document.getElementById('rutasColumnasEsperadas').innerHTML = 
                    '- Columnas: DEPOSITO, CODIGO UPC, ARTICULO, CANTIDAD, INDICADOR, FECHA, DEPOSITO DESTINO, COLA<br>' +
                    '- Separador: tabulaci√≥n<br>' +
                    '- Codificaci√≥n: UTF-8';
            } else {
                document.getElementById('rutasModalTitle').textContent = 'Subir Rutas de Reposici√≥n';
                document.getElementById('rutasModalDescription').textContent = 'Selecciona el archivo CSV con los datos de reposici√≥n:';
                document.getElementById('rutasColumnasEsperadas').innerHTML = 
                    '- Columnas: DEPOSITO, CODIGO_UPC, ARTICULO, CANTIDAD, FECHA<br>' +
                    '- Separador: tabulaci√≥n<br>' +
                    '- Codificaci√≥n: UTF-8';
            }
            
            document.getElementById('rutasModal').style.display = 'flex';
            document.getElementById('uploadProgressBar').style.display = 'none';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('rutasFile').value = '';
            document.getElementById('rutasPassword').value = '';
            
            // Resetear modo a "reemplazar" por defecto
            seleccionarModo('replace');
        }

        function seleccionarModo(modo) {
            modoSubidaActual = modo;
            
            document.getElementById('modeReplace').classList.remove('selected');
            document.getElementById('modeAdd').classList.remove('selected');
            
            if (modo === 'replace') {
                document.getElementById('modeReplace').classList.add('selected');
            } else {
                document.getElementById('modeAdd').classList.add('selected');
            }
        }

        function cerrarRutasModal() {
            document.getElementById('rutasModal').style.display = 'none';
        }

        async function procesarRutas() {
            const fileInput = document.getElementById('rutasFile');
            const file = fileInput.files[0];
            const password = document.getElementById('rutasPassword').value;
            
            // VERIFICAR CONTRASE√ëA
            if (password !== PASSWORD_RUTAS) {
                mostrarMensaje('‚ùå Contrase√±a incorrecta. No tienes permisos para subir rutas.', false);
                return;
            }
            
            if (!file) {
                mostrarMensaje('Por favor, selecciona un archivo CSV', false);
                return;
            }
            
            // Mostrar progreso
            document.getElementById('uploadProgressBar').style.display = 'block';
            document.getElementById('uploadProgressFill').style.width = '10%';
            document.getElementById('uploadStatus').textContent = 'Leyendo archivo...';
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    document.getElementById('uploadProgressFill').style.width = '30%';
                    document.getElementById('uploadStatus').textContent = 'Procesando datos...';
                    
                    // Procesar CSV seg√∫n el tipo
                    let datosProcesados;
                    if (tipoRutaActual === 'recoleccion') {
                        datosProcesados = procesarCSVRecoleccion(csvText);
                    } else {
                        datosProcesados = procesarCSVReposicion(csvText);
                    }
                    
                    document.getElementById('uploadProgressFill').style.width = '60%';
                    document.getElementById('uploadStatus').textContent = 'Subiendo a Firebase...';
                    
                    // Subir a Firebase seg√∫n el modo seleccionado
                    const rutaFirebase = tipoRutaActual === 'recoleccion' ? 'recoleccion_rutas' : 'reposicion_rutas';
                    
                    if (modoSubidaActual === 'replace') {
                        // Reemplazar todos los datos
                        await database.ref(rutaFirebase).set(datosProcesados);
                    } else {
                        // A√±adir a los datos existentes
                        const snapshot = await database.ref(rutaFirebase).once('value');
                        const datosExistentes = snapshot.val() || {};
                        
                        // Combinar datos existentes con nuevos
                        const datosCombinados = { ...datosExistentes, ...datosProcesados };
                        
                        // Subir datos combinados
                        await database.ref(rutaFirebase).set(datosCombinados);
                    }

                    // Guardar la fecha de √∫ltima actualizaci√≥n
                    await database.ref(`estado/${rutaFirebase}_lastUpdate`).set(new Date().toISOString());
                    
                    document.getElementById('uploadProgressFill').style.width = '100%';
                    document.getElementById('uploadStatus').textContent = '‚úÖ Datos subidos correctamente';
                    
                    // Actualizar informaci√≥n
                    setTimeout(() => {
                        cerrarRutasModal();
                        cargarRutasDesdeFirebase();
                        mostrarMensaje(`‚úÖ ${tipoRutaActual === 'recoleccion' ? 'Recolecci√≥n' : 'Reposici√≥n'} actualizada correctamente. Modo: ${modoSubidaActual === 'replace' ? 'REEMPLAZAR' : 'A√ëADIR'}.`, true);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error procesando rutas:', error);
                    document.getElementById('uploadStatus').textContent = `‚ùå Error: ${error.message}`;
                    document.getElementById('uploadProgressFill').style.width = '0%';
                    mostrarMensaje(`‚ùå Error procesando archivo: ${error.message}`, false);
                }
            };
            
            reader.onerror = function() {
                document.getElementById('uploadStatus').textContent = '‚ùå Error al leer el archivo';
                document.getElementById('uploadProgressFill').style.width = '0%';
                mostrarMensaje('‚ùå Error al leer el archivo seleccionado', false);
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function procesarCSVRecoleccion(csvText) {
            const datos = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                throw new Error('El archivo CSV est√° vac√≠o');
            }
            
            // Detectar separador (usualmente tabulaci√≥n para estos archivos)
            const primeraLinea = lineas[0];
            const separador = primeraLinea.includes('\t') ? '\t' : ',';
            
            // Verificar encabezados
            const encabezados = primeraLinea.split(separador).map(h => h.trim().replace(/^"|"$/g, ''));
            
            const encabezadosEsperados = ['DEPOSITO', 'CODIGO UPC', 'ARTICULO', 'CANTIDAD', 'INDICADOR', 'FECHA', 'DEPOSITO DESTINO', 'COLA'];
            if (encabezados.length < 5) {
                throw new Error('Formato de archivo incorrecto. Se esperaban columnas: DEPOSITO, CODIGO UPC, ARTICULO, CANTIDAD, INDICADOR, FECHA, DEPOSITO DESTINO, COLA');
            }
            
            // Procesar datos
            let registrosProcesados = 0;
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 5) {
                    const deposito = partes[0];
                    const upc = partes[1];
                    const articulo = partes[2];
                    const cantidad = parseInt(partes[3]) || 0;
                    const indicador = partes[4] || 'Regular';
                    const fecha = partes[5] || new Date().toLocaleDateString();
                    const deposito_destino = partes[6] || ''; // Nueva columna
                    const cola_reposicion = partes[7] || ''; // Nueva columna
                    
                    if (deposito && upc) {
                        // Crear ID √∫nico para el registro
                        const id = `${deposito}_${upc}_${indicador}`;
                        
                        datos[id] = {
                            deposito: deposito,
                            upc: upc,
                            articulo: articulo,
                            cantidad: cantidad,
                            indicador: indicador,
                            fecha: fecha,
                            deposito_destino: deposito_destino,
                            cola_reposicion: cola_reposicion
                        };
                        registrosProcesados++;
                    }
                }
            }
            
            if (registrosProcesados === 0) {
                throw new Error('No se encontraron datos v√°lidos en el archivo');
            }
            
            return datos;
        }

        function procesarCSVReposicion(csvText) {
            const datos = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                throw new Error('El archivo CSV est√° vac√≠o');
            }
            
            // Detectar separador (usualmente tabulaci√≥n para estos archivos)
            const primeraLinea = lineas[0];
            const separador = primeraLinea.includes('\t') ? '\t' : ',';
            
            // Verificar encabezados
            const encabezados = primeraLinea.split(separador).map(h => h.trim().replace(/^"|"$/g, ''));
            
            if (encabezados.length < 4) {
                throw new Error('Formato de archivo incorrecto. Se esperaban columnas: DEPOSITO, CODIGO_UPC, ARTICULO, CANTIDAD, FECHA');
            }
            
            // Procesar datos
            let registrosProcesados = 0;
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 4) {
                    const deposito = partes[0];
                    const upc = partes[1];
                    const articulo = partes[2];
                    const cantidad = parseInt(partes[3]) || 0;
                    
                    if (deposito && upc) {
                        // Crear ID √∫nico para el registro
                        const id = `${deposito}_${upc}`;
                        
                        datos[id] = {
                            deposito: deposito,
                            upc: upc,
                            articulo: articulo,
                            cantidad: cantidad,
                            fecha: partes[4] || new Date().toLocaleDateString()
                        };
                        registrosProcesados++;
                    }
                }
            }
            
            if (registrosProcesados === 0) {
                throw new Error('No se encontraron datos v√°lidos en el archivo');
            }
            
            return datos;
        }

        async function cargarRutasDesdeFirebase() {
            try {
                // Cargar datos de recolecci√≥n
                const snapshotRecoleccion = await database.ref('recoleccion_rutas').once('value');
                recoleccionData = snapshotRecoleccion.val() || {};
                
                // Cargar √∫ltima actualizaci√≥n de recolecci√≥n
                const lastUpdateRecoleccion = await database.ref('estado/recoleccion_rutas_lastUpdate').once('value');
                const lastUpdateRecoleccionDate = lastUpdateRecoleccion.val() ? new Date(lastUpdateRecoleccion.val()).toLocaleString() : '-';

                // Actualizar informaci√≥n en la UI
                document.getElementById('recoleccionTotalRecords').textContent = Object.keys(recoleccionData).length;
                document.getElementById('recoleccionLastUpdate').textContent = lastUpdateRecoleccionDate;
                
                if (Object.keys(recoleccionData).length > 0) {
                    document.getElementById('recoleccionStatus').textContent = 'Datos cargados';
                    document.getElementById('recoleccionStatus').style.color = '#27ae60';
                    
                    // Mostrar vista previa
                    mostrarVistaPreviaRecoleccion();
                } else {
                    document.getElementById('recoleccionStatus').textContent = 'No hay datos cargados';
                    document.getElementById('recoleccionStatus').style.color = '#e74c3c';
                    document.getElementById('recoleccionPreview').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error cargando rutas:', error);
                document.getElementById('recoleccionStatus').textContent = 'Error al cargar datos';
                document.getElementById('recoleccionStatus').style.color = '#e74c3c';
            }
        }

        function mostrarVistaPreviaRecoleccion() {
            const previewBody = document.getElementById('recoleccionPreviewBody');
            previewBody.innerHTML = '';
            
            const ids = Object.keys(recoleccionData);
            const registrosMostrar = Math.min(5, ids.length);
            
            for (let i = 0; i < registrosMostrar; i++) {
                const id = ids[i];
                const registro = recoleccionData[id];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${registro.deposito}</td>
                    <td>${registro.upc}</td>
                    <td>${registro.articulo}</td>
                    <td>${registro.cantidad}</td>
                    <td>${registro.indicador}</td>
                `;
                previewBody.appendChild(row);
            }
            
            document.getElementById('recoleccionPreview').style.display = 'block';
        }

        function verificarRutasActuales() {
            cargarRutasDesdeFirebase();
            mostrarMensaje(`Rutas actualizadas: Recolecci√≥n (${Object.keys(recoleccionData).length})`, true);
        }

        // ================= GESTI√ìN DE SLOTING =================
        function solicitarSubirSloting() {
            document.getElementById('slotingModal').style.display = 'flex';
            document.getElementById('slotingProgressBar').style.display = 'none';
            document.getElementById('slotingUploadStatus').textContent = '';
            document.getElementById('slotingFile').value = '';
            document.getElementById('slotingPassword').value = '';
        }

        function cerrarSlotingModal() {
            document.getElementById('slotingModal').style.display = 'none';
        }

        async function procesarSloting() {
            const fileInput = document.getElementById('slotingFile');
            const file = fileInput.files[0];
            const password = document.getElementById('slotingPassword').value;
            
            // VERIFICAR CONTRASE√ëA
            if (password !== PASSWORD_SLOTING) {
                mostrarMensaje('‚ùå Contrase√±a incorrecta. No tienes permisos para subir sloting.', false);
                return;
            }
            
            if (!file) {
                mostrarMensaje('Por favor, selecciona un archivo CSV', false);
                return;
            }
            
            // Mostrar progreso
            document.getElementById('slotingProgressBar').style.display = 'block';
            document.getElementById('slotingProgressFill').style.width = '10%';
            document.getElementById('slotingUploadStatus').textContent = 'Leyendo archivo...';
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    document.getElementById('slotingProgressFill').style.width = '30%';
                    document.getElementById('slotingUploadStatus').textContent = 'Procesando datos...';
                    
                    // Procesar CSV
                    const datosProcesados = procesarCSVSloting(csvText);
                    document.getElementById('slotingProgressFill').style.width = '60%';
                    document.getElementById('slotingUploadStatus').textContent = 'Subiendo a Firebase...';
                    
                    // Subir a Firebase
                    await database.ref('sloting').set(datosProcesados);

                    // Guardar la fecha de √∫ltima actualizaci√≥n
                    await database.ref('estado/sloting_lastUpdate').set(new Date().toISOString());
                    
                    document.getElementById('slotingProgressFill').style.width = '100%';
                    document.getElementById('slotingUploadStatus').textContent = '‚úÖ Sloting subido correctamente';
                    
                    // Actualizar informaci√≥n del sloting
                    setTimeout(() => {
                        cerrarSlotingModal();
                        cargarSlotingDesdeFirebase();
                        mostrarMensaje(`‚úÖ Sloting actualizado correctamente. ${Object.keys(datosProcesados).length} registros procesados.`, true);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error procesando sloting:', error);
                    document.getElementById('slotingUploadStatus').textContent = `‚ùå Error: ${error.message}`;
                    document.getElementById('slotingProgressFill').style.width = '0%';
                    mostrarMensaje(`‚ùå Error procesando archivo: ${error.message}`, false);
                }
            };
            
            reader.onerror = function() {
                document.getElementById('slotingUploadStatus').textContent = '‚ùå Error al leer el archivo';
                document.getElementById('slotingProgressFill').style.width = '0%';
                mostrarMensaje('‚ùå Error al leer el archivo seleccionado', false);
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function procesarCSVSloting(csvText) {
            const datos = {};
            const lineas = csvText.split('\n').filter(linea => linea.trim());
            
            if (lineas.length < 2) {
                throw new Error('El archivo CSV est√° vac√≠o');
            }
            
            // Detectar separador
            const primeraLinea = lineas[0];
            const separador = primeraLinea.includes('\t') ? '\t' : ',';
            
            // Verificar encabezados
            const encabezados = primeraLinea.split(separador).map(h => h.trim().replace(/^"|"$/g, ''));
            
            if (encabezados.length < 3 || 
                !encabezados[0].includes('UPC') || 
                !encabezados[1].includes('ARTICULO') || 
                !encabezados[2].includes('DEPOSITO')) {
                throw new Error('Formato de archivo incorrecto. Se esperaban columnas: CODIGO_UPC, ARTICULO, DEPOSITO FINAL');
            }
            
            // Procesar datos
            let registrosProcesados = 0;
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                const partes = linea.split(separador).map(part => part.trim().replace(/^"|"$/g, ''));
                
                if (partes.length >= 3) {
                    const upc = partes[0];
                    const articulo = partes[1];
                    const deposito = partes[2];
                    
                    if (upc && articulo && deposito) {
                        datos[upc] = {
                            articulo: articulo,
                            deposito: deposito
                        };
                        registrosProcesados++;
                    }
                }
            }
            
            if (registrosProcesados === 0) {
                throw new Error('No se encontraron datos v√°lidos en el archivo');
            }
            
            return datos;
        }

        async function cargarSlotingDesdeFirebase() {
            try {
                const snapshot = await database.ref('sloting').once('value');
                slotingData = snapshot.val() || {};

                // Cargar √∫ltima actualizaci√≥n del sloting
                const lastUpdateSloting = await database.ref('estado/sloting_lastUpdate').once('value');
                const lastUpdateSlotingDate = lastUpdateSloting.val() ? new Date(lastUpdateSloting.val()).toLocaleString() : '-';
                
                // Actualizar informaci√≥n en la UI
                document.getElementById('slotingTotalRecords').textContent = Object.keys(slotingData).length;
                document.getElementById('slotingLastUpdate').textContent = lastUpdateSlotingDate;
                
                if (Object.keys(slotingData).length > 0) {
                    document.getElementById('slotingStatus').textContent = 'Datos cargados';
                    document.getElementById('slotingStatus').style.color = '#27ae60';
                    
                    // Mostrar vista previa
                    mostrarVistaPreviaSloting();
                } else {
                    document.getElementById('slotingStatus').textContent = 'No hay datos cargados';
                    document.getElementById('slotingStatus').style.color = '#e74c3c';
                    document.getElementById('slotingPreview').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error cargando sloting:', error);
                document.getElementById('slotingStatus').textContent = 'Error al cargar datos';
                document.getElementById('slotingStatus').style.color = '#e74c3c';
            }
        }

        function mostrarVistaPreviaSloting() {
            const previewBody = document.getElementById('slotingPreviewBody');
            previewBody.innerHTML = '';
            
            const upcs = Object.keys(slotingData);
            const registrosMostrar = Math.min(5, upcs.length);
            
            for (let i = 0; i < registrosMostrar; i++) {
                const upc = upcs[i];
                const registro = slotingData[upc];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${upc}</td>
                    <td>${registro.articulo}</td>
                    <td>${registro.deposito}</td>
                `;
                previewBody.appendChild(row);
            }
            
            document.getElementById('slotingPreview').style.display = 'block';
        }

        // ================= FUNCIONES PRINCIPALES DEL ADMINISTRADOR =================
        async function cargarDashboard() {
            try {
                mostrarMensaje('Cargando datos del sistema...', true);
                
                // Cargar datos de Firebase
                await cargarDatosFirebase();
                
                // Procesar y mostrar datos
                actualizarEstadisticas();
                actualizarTablaEstadoRutas();
                
                mostrarMensaje('Dashboard actualizado correctamente', true);
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                mostrarMensaje('Error al cargar el dashboard: ' + error.message, false);
            }
        }

        async function cargarDatosFirebase() {
            return new Promise((resolve, reject) => {
                // Cargar estado de rutas desde Firebase
                database.ref('estado').once('value')
                    .then(snapshot => {
                        estadoDesdeFirebase = snapshot.val() || {};
                        console.log('Estado cargado desde Firebase:', estadoDesdeFirebase);
                        
                        // Cargar rutas de recolecci√≥n
                        return database.ref('recoleccion_rutas').once('value');
                    })
                    .then(snapshot => {
                        rutasRecoleccionDesdeFirebase = snapshot.val() || {};
                        console.log('Rutas de recolecci√≥n cargadas:', Object.keys(rutasRecoleccionDesdeFirebase).length);
                        
                        // Cargar rutas de reposici√≥n
                        return database.ref('reposicion_rutas').once('value');
                    })
                    .then(snapshot => {
                        rutasReposicionDesdeFirebase = snapshot.val() || {};
                        console.log('Rutas de reposici√≥n cargadas:', Object.keys(rutasReposicionDesdeFirebase).length);
                        
                        // Cargar registros de recolecci√≥n
                        return database.ref('recolecciones').once('value');
                    })
                    .then(snapshot => {
                        const registros = snapshot.val();
                        registrosRecoleccion = registros ? Object.values(registros) : [];
                        console.log('Registros de recolecci√≥n cargados:', registrosRecoleccion.length);
                        
                        // Cargar registros de reposici√≥n (si existen)
                        return database.ref('reposiciones').once('value');
                    })
                    .then(snapshot => {
                        const registros = snapshot.val();
                        registrosReposicion = registros ? Object.values(registros) : [];
                        console.log('Registros de reposici√≥n cargados:', registrosReposicion.length);
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error cargando datos de Firebase:', error);
                        reject(error);
                    });
            });
        }

        function actualizarEstadisticas() {
            // Obtener fecha actual para filtrar
            const fechaActual = new Date().toISOString().split('T')[0];
            
            let rutasActivas, rutasCompletadas, operariosUnicos, totalRegistros;
            
            if (moduloActual === 'recoleccion') {
                // Filtrar registros de recolecci√≥n por fecha actual
                const registrosHoy = registrosRecoleccion.filter(reg => {
                    const fechaReg = reg.timestamp ? new Date(reg.timestamp).toISOString().split('T')[0] : null;
                    return fechaReg === fechaActual;
                });
                
                // Agrupar por ruta y cola
                const grupos = agruparRecoleccionPorRutaYCola(registrosHoy);
                rutasActivas = Object.keys(grupos).length;
                rutasCompletadas = calcularRutasCompletadasRecoleccion(grupos);
                operariosUnicos = new Set();
                totalRegistros = registrosHoy.length;
                
                registrosHoy.forEach(registro => {
                    if (registro.usuario) operariosUnicos.add(registro.usuario);
                });
            } else {
                // Para reposici√≥n, usar datos de recolecci√≥n del d√≠a actual
                const registrosHoy = registrosRecoleccion.filter(reg => {
                    const fechaReg = reg.timestamp ? new Date(reg.timestamp).toISOString().split('T')[0] : null;
                    return fechaReg === fechaActual;
                });
                
                // Agrupar por cola de reposici√≥n
                const grupos = agruparReposicionPorCola(registrosHoy);
                rutasActivas = Object.keys(grupos).length;
                rutasCompletadas = calcularRutasCompletadasReposicion(grupos);
                operariosUnicos = new Set();
                totalRegistros = registrosHoy.length;
                
                registrosHoy.forEach(registro => {
                    if (registro.usuario) operariosUnicos.add(registro.usuario);
                });
            }
            
            // Actualizar UI
            document.getElementById('totalRutas').textContent = rutasActivas;
            document.getElementById('rutasCompletadas').textContent = rutasCompletadas;
            document.getElementById('totalOperarios').textContent = operariosUnicos.size;
            document.getElementById('totalRegistros').textContent = totalRegistros;
        }

        // Funci√≥n para agrupar registros de recolecci√≥n por ruta y cola
        function agruparRecoleccionPorRutaYCola(registros) {
            const grupos = {};
            
            registros.forEach(registro => {
                // Obtener ruta del dep√≥sito (primera parte antes del gui√≥n)
                const ruta = registro.deposito ? registro.deposito.split('-')[0] : 'SIN_RUTA';
                
                // Obtener cola seg√∫n las reglas de agrupaci√≥n
                const cola = obtenerColaRecoleccion(registro.deposito);
                
                const clave = `${ruta}-${cola}`;
                
                if (!grupos[clave]) {
                    grupos[clave] = {
                        ruta: ruta,
                        cola: cola,
                        total: 0,
                        completado: 0,
                        recolector: registro.usuario,
                        ultimaActualizacion: registro.timestamp
                    };
                }
                
                // Sumar cantidad planificada
                grupos[clave].total += registro.cantidad || 0;
                
                // Sumar cantidad recolectada
                grupos[clave].completado += registro.recolectado || 0;
                
                // Actualizar recolector y fecha si es m√°s reciente
                if (registro.timestamp && (!grupos[clave].ultimaActualizacion || registro.timestamp > grupos[clave].ultimaActualizacion)) {
                    grupos[clave].recolector = registro.usuario;
                    grupos[clave].ultimaActualizacion = registro.timestamp;
                }
            });
            
            return grupos;
        }

        // Funci√≥n para agrupar registros de reposici√≥n por cola
        function agruparReposicionPorCola(registrosRecoleccion) {
            const grupos = {};
            
            registrosRecoleccion.forEach(registro => {
                // Obtener cola de reposici√≥n del deposito_destino
                const cola = obtenerColaReposicion(registro.deposito_destino);
                
                if (!cola || cola === 'OTROS') return; // Saltar si no hay cola v√°lida
                
                if (!grupos[cola]) {
                    grupos[cola] = {
                        cola: cola,
                        total: 0,
                        completado: 0,
                        recolector: registro.usuario,
                        ultimaActualizacion: registro.timestamp
                    };
                }
                
                // Para reposici√≥n, el total es la cantidad planificada de recolecci√≥n
                grupos[cola].total += registro.cantidad || 0;
                
                // El completado es lo que se ha recolectado (que activa la reposici√≥n)
                grupos[cola].completado += registro.recolectado || 0;
                
                // Actualizar recolector y fecha si es m√°s reciente
                if (registro.timestamp && (!grupos[cola].ultimaActualizacion || registro.timestamp > grupos[cola].ultimaActualizacion)) {
                    grupos[cola].recolector = registro.usuario;
                    grupos[cola].ultimaActualizacion = registro.timestamp;
                }
            });
            
            return grupos;
        }

        function calcularRutasCompletadasRecoleccion(grupos) {
            let completadas = 0;
            Object.values(grupos).forEach(grupo => {
                const porcentaje = grupo.total > 0 ? Math.round((grupo.completado / grupo.total) * 100) : 0;
                if (porcentaje === 100) completadas++;
            });
            return completadas;
        }

        function calcularRutasCompletadasReposicion(grupos) {
            let completadas = 0;
            Object.values(grupos).forEach(grupo => {
                const porcentaje = grupo.total > 0 ? Math.round((grupo.completado / grupo.total) * 100) : 0;
                if (porcentaje === 100) completadas++;
            });
            return completadas;
        }

        function actualizarTablaEstadoRutas() {
            const tbody = document.getElementById('dashboardTableBody');
            const thead = document.getElementById('dashboardTableHead');
            tbody.innerHTML = '';
            
            // Obtener fecha actual para filtrar
            const fechaActual = new Date().toISOString().split('T')[0];
            
            let grupos;
            if (moduloActual === 'recoleccion') {
                // Configurar encabezados para recolecci√≥n
                thead.innerHTML = `
                    <tr>
                        <th>Ruta</th>
                        <th>Cola</th>
                        <th>Estado</th>
                        <th>Recolector</th>
                        <th>Progreso</th>
                        <th>√öltima Actualizaci√≥n</th>
                    </tr>
                `;
                
                // Filtrar registros de recolecci√≥n por fecha actual y agrupar
                const registrosHoy = registrosRecoleccion.filter(reg => {
                    const fechaReg = reg.timestamp ? new Date(reg.timestamp).toISOString().split('T')[0] : null;
                    return fechaReg === fechaActual;
                });
                
                grupos = agruparRecoleccionPorRutaYCola(registrosHoy);
            } else {
                // Configurar encabezados para reposici√≥n
                thead.innerHTML = `
                    <tr>
                        <th>Cola</th>
                        <th>Estado</th>
                        <th>Recolector</th>
                        <th>Progreso</th>
                        <th>√öltima Actualizaci√≥n</th>
                    </tr>
                `;
                
                // Filtrar registros de recolecci√≥n por fecha actual y agrupar para reposici√≥n
                const registrosHoy = registrosRecoleccion.filter(reg => {
                    const fechaReg = reg.timestamp ? new Date(reg.timestamp).toISOString().split('T')[0] : null;
                    return fechaReg === fechaActual;
                });
                
                grupos = agruparReposicionPorCola(registrosHoy);
            }
            
            if (Object.keys(grupos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No hay datos disponibles para este m√≥dulo</td></tr>';
            } else {
                Object.values(grupos).forEach(grupo => {
                    const porcentaje = grupo.total > 0 ? Math.round((grupo.completado / grupo.total) * 100) : 0;
                    let estadoClass, estadoText;
                    
                    // Determinar estado
                    if (porcentaje === 100) {
                        estadoClass = 'status-completed';
                        estadoText = 'COMPLETADA';
                    } else if (porcentaje > 0) {
                        estadoClass = 'status-in-progress';
                        estadoText = 'EN PROGRESO';
                    } else {
                        estadoClass = 'status-pending';
                        estadoText = 'PENDIENTE';
                    }
                    
                    const row = document.createElement('tr');
                    
                    if (moduloActual === 'recoleccion') {
                        row.innerHTML = `
                            <td>${grupo.ruta}</td>
                            <td>${grupo.cola}</td>
                            <td class="${estadoClass}">${estadoText}</td>
                            <td>${grupo.recolector || '-'}</td>
                            <td>${grupo.completado}/${grupo.total} (${porcentaje}%)</td>
                            <td>${grupo.ultimaActualizacion ? new Date(grupo.ultimaActualizacion).toLocaleString() : '-'}</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td>${grupo.cola}</td>
                            <td class="${estadoClass}">${estadoText}</td>
                            <td>${grupo.recolector || '-'}</td>
                            <td>${grupo.completado}/${grupo.total} (${porcentaje}%)</td>
                            <td>${grupo.ultimaActualizacion ? new Date(grupo.ultimaActualizacion).toLocaleString() : '-'}</td>
                        `;
                    }
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('dashboardLoading').style.display = 'none';
            document.getElementById('dashboardTable').style.display = 'table';
        }

        async function actualizarDesdeFirebase() {
            try {
                mostrarMensaje('Actualizando desde Firebase...', true);
                
                await cargarDatosFirebase();
                await cargarRutasDesdeFirebase();
                
                // Actualizar la vista
                actualizarEstadisticas();
                actualizarTablaEstadoRutas();
                
                mostrarMensaje('‚úÖ Datos actualizados desde Firebase correctamente', true);
                
            } catch (error) {
                console.error('Error actualizando desde Firebase:', error);
                mostrarMensaje('‚ùå Error al actualizar desde Firebase: ' + error.message, false);
            }
        }

        // ================= FUNCIONES DE REPORTES MEJORADAS =================
        async function descargarReporteRecoleccion() {
            try {
                const fechaInicio = document.getElementById('fechaInicioRecoleccion').value;
                const fechaFin = document.getElementById('fechaFinRecoleccion').value;
                
                if (!fechaInicio || !fechaFin) {
                    mostrarMensaje('Por favor, selecciona ambas fechas', false);
                    return;
                }
                
                mostrarMensaje('Generando reporte de recolecci√≥n...', true);
                
                // CORRECCI√ìN: Ajustar fechas para cubrir todo el d√≠a
                const inicio = new Date(fechaInicio);
                inicio.setHours(0, 0, 0, 0); // Inicio del d√≠a
                
                const fin = new Date(fechaFin);
                fin.setHours(23, 59, 59, 999); // Fin del d√≠a
                
                const registrosFiltrados = registrosRecoleccion.filter(reg => {
                    if (!reg.timestamp) return false;
                    const fechaReg = new Date(reg.timestamp);
                    return fechaReg >= inicio && fechaReg <= fin;
                });
                
                if (registrosFiltrados.length === 0) {
                    mostrarMensaje('No hay registros de recolecci√≥n en el rango de fechas seleccionado', false);
                    return;
                }
                
                generarExcelRecoleccion(registrosFiltrados, fechaInicio, fechaFin);
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                mostrarMensaje('Error al generar reporte: ' + error.message, false);
            }
        }

        function generarExcelRecoleccion(registros, fechaInicio, fechaFin) {
            try {
                // Preparar los datos para Excel
                const datosExcel = registros.map(reg => ({
                    'USUARIO': reg.usuario || '',
                    'RUTA': reg.ruta || '',
                    'COLA': reg.cola || '',
                    'DEPOSITO': reg.deposito || '',
                    'UPC': reg.upc || '',
                    'DESCRIPCION': reg.descripcion || '',
                    'CANTIDAD_PLANIFICADA': reg.cantidad || 0,
                    'CANTIDAD_RECOLECTADA': reg.recolectado || 0,
                    'NO_ENCONTRADO': reg.no_encontrado || 0,
                    'ACCION': reg.accion || '',
                    'TIPO_RECOLECCION': reg.tipoRecoleccion || '',
                    'DEPOSITO_DESTINO': reg.deposito_destino || '',
                    'COLA_REPOSICION': reg.cola_reposicion || '',
                    'FECHA': reg.fecha || '',
                    'HORA': reg.hora || '',
                    'TIMESTAMP': reg.timestamp || ''
                }));
                
                // Crear libro de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datosExcel);
                
                // A√±adir hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, "Reporte Recolecci√≥n");
                
                // Generar y descargar archivo
                XLSX.writeFile(wb, `reporte_recoleccion_${fechaInicio}_${fechaFin}.xlsx`);
                
                mostrarMensaje(`‚úÖ Reporte de recolecci√≥n descargado (${registros.length} registros)`, true);
            } catch (error) {
                console.error('Error generando Excel:', error);
                mostrarMensaje('‚ùå Error al generar archivo Excel: ' + error.message, false);
            }
        }

        async function descargarReporteReposicion() {
            try {
                const fechaInicio = document.getElementById('fechaInicioReposicion').value;
                const fechaFin = document.getElementById('fechaFinReposicion').value;
                
                if (!fechaInicio || !fechaFin) {
                    mostrarMensaje('Por favor, selecciona ambas fechas', false);
                    return;
                }
                
                mostrarMensaje('Generando reporte de reposici√≥n...', true);
                
                // CORRECCI√ìN: Ajustar fechas para cubrir todo el d√≠a
                const inicio = new Date(fechaInicio);
                inicio.setHours(0, 0, 0, 0);
                
                const fin = new Date(fechaFin);
                fin.setHours(23, 59, 59, 999);
                
                const registrosFiltrados = registrosReposicion.filter(reg => {
                    if (!reg.timestamp) return false;
                    const fechaReg = new Date(reg.timestamp);
                    return fechaReg >= inicio && fechaReg <= fin;
                });
                
                if (registrosFiltrados.length === 0) {
                    mostrarMensaje('No hay registros de reposici√≥n en el rango de fechas seleccionado', false);
                    return;
                }
                
                generarExcelReposicion(registrosFiltrados, fechaInicio, fechaFin);
                
            } catch (error) {
                console.error('Error generando reporte de reposici√≥n:', error);
                mostrarMensaje('Error al generar reporte de reposici√≥n: ' + error.message, false);
            }
        }

        function generarExcelReposicion(registros, fechaInicio, fechaFin) {
            try {
                // Preparar los datos para Excel
                const datosExcel = registros.map(reg => ({
                    'USUARIO': reg.usuario || '',
                    'RUTA': reg.ruta || '',
                    'COLA': reg.cola || '',
                    'DEPOSITO': reg.deposito || '',
                    'UPC': reg.upc || '',
                    'DESCRIPCION': reg.descripcion || '',
                    'CANTIDAD': reg.cantidad || 0,
                    'FECHA': reg.fecha || (reg.timestamp ? new Date(reg.timestamp).toLocaleDateString() : ''),
                    'HORA': reg.hora || (reg.timestamp ? new Date(reg.timestamp).toLocaleTimeString() : ''),
                    'TIMESTAMP': reg.timestamp || ''
                }));
                
                // Crear libro de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(datosExcel);
                
                // A√±adir hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, "Reporte Reposici√≥n");
                
                // Generar y descargar archivo
                XLSX.writeFile(wb, `reporte_reposicion_${fechaInicio}_${fechaFin}.xlsx`);
                
                mostrarMensaje(`‚úÖ Reporte de reposici√≥n descargado (${registros.length} registros)`, true);
            } catch (error) {
                console.error('Error generando Excel:', error);
                mostrarMensaje('‚ùå Error al generar archivo Excel: ' + error.message, false);
            }
        }

        // ================= FUNCIONES GENERALES =================
        function volverInterfazPrincipal() {
            window.location.href = 'index.html';
        }

        function mostrarMensaje(mensaje, esExito) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = esExito ? 'status-message success-message' : 'status-message error-message';
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Actualizar autom√°ticamente cada 2 minutos
        setInterval(() => {
            cargarDashboard();
        }, 120000);
    </script>
</body>
</html>